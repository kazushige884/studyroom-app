<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>自習室管理（統合版・ログ集約連携）</title>
<style>
  :root{
    --bg:#000; --text:#eaeaea; --panel:#111; --border:#2a2a2a;
    --blue:#4fc3f7; --navy:#0b2a6b; --pink:#ffc0cb; --red:#ff2d55;
    --gap:4px; --cell:42px;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;}
  .hidden{display:none !important}
  .container{min-height:100%;padding:16px;box-sizing:border-box}

  /* ===== ① タイトルメニュー ===== */
  #view-title .title{font-size:100pt;margin:6vh 0 16px;text-align:center}
  #view-title .login-inline{
    margin:0 auto;display:flex;flex-direction:column;gap:18px;
    background:#111;border:1px solid var(--border);border-radius:14px;
    padding:16px 20px;width:min(92vw,900px);
  }
  #view-title .inline-row{display:grid;grid-template-columns:260px 1fr;gap:16px;align-items:center}
  #view-title .inline-label{font-size:40pt;line-height:1;white-space:nowrap}
  #view-title .inline-input{
    font-size:40px;padding:12px 14px;border-radius:10px;border:1px solid var(--border);
    background:#0f0f0f;color:#fff;outline:none;width:100%;box-sizing:border-box
  }
  #view-title .login-btn{
    margin-top:20px;align-self:center;font-size:20px;padding:12px 40px;
    background:#fff;color:#000;border:none;border-radius:10px;cursor:pointer;font-weight:bold;
    display:block;
  }

  /* ===== ② スライドショー設定 ===== */
  #view-ss .wrap{max-width:1000px;margin:0 auto;display:flex;flex-direction:column;gap:14px}
  #view-ss h1{margin:0 0 8px}
  #view-ss .card{background:#111;border:1px solid var(--border);border-radius:14px;padding:16px}
  #view-ss .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  #view-ss .row.right{justify-content:flex-end}
  #view-ss label{min-width:12em}
  #view-ss input[type="number"]{width:120px}
  #view-ss input, #view-ss button{font-size:1.5em}
  #view-ss .btn{border:none;border-radius:10px;padding:8px 16px;font-weight:700;cursor:pointer}
  #view-ss .btn.ghost{background:#1b1b1b;color:#fff;border:1px solid var(--border)}
  #view-ss .btn.primary{background:#fff;color:#000}
  #view-ss .file-row{display:flex;flex-direction:column;gap:6px;align-items:flex-start}
  #view-ss .file-row > div{display:flex;align-items:center;gap:12px;width:100%}
  #view-ss .file-row .push-right{margin-left:auto}
  #view-ss .file-row input[type="file"]{min-width:0}
  #view-ss .note{color:#9aa0a6}

  /* ===== ③ メインメニュー ===== */
  #view-main .wrap{display:flex;flex-direction:column;align-items:center;gap:18px}
   #view-main .title{font-size:40pt;margin:0 0 12px;align-self:flex-start}
    #view-main .btn-row{
  display:flex; gap:var(--gap);
  width:min(92vw, 800px);          /* ← 「レイアウト作成」と同じ幅 */
  margin:0 auto;                   /* 中央寄せ */
  justify-content:space-between;   /* 左右端を揃える */
  flex-wrap:nowrap;                /* 1行に固定 */
  position:relative; z-index:5;
}
  /* ボタンの幅とフォントサイズの調整（上書き） */
#view-main #btnGoSs,
#view-main #btnGoLottery{
  flex: 1 1 calc(50% - var(--gap)); /* ← 2つで基準幅いっぱい（左右端が揃う） */
  min-width: 0;
  display:flex; align-items:center; justify-content:center;
  white-space:nowrap;               /* ← 中で改行させない */
  text-align:center;
  line-height:1.2;
  min-height:120px;
  padding:12px 16px;
  font-size:24pt;
}

/* 念押し：<br> を確実に改行として扱う */
#view-main #btnGoSs br,
#view-main #btnGoLottery br { display: inline !important; }

#view-main #btnGoSs {
  transform: none;
}

#view-main #btnGoLottery {
  transform: none;
}

/* 「スライドショー設定」「抽選設定」— 改行せず通常表示 */
#view-main #btnGoSs{
  font-size: calc(24pt * 0.8);
  color: #000;
  position: static;
}
#view-main #btnGoLottery{
  color: #000;
  position: static;
}

/* 「抽選設定」— 擬似要素を使わず通常表示 */
#view-main #btnGoLottery{
  color: #000;
  position: static;
}

/* スマホなど画面幅が狭い場合の調整 */
@media (max-width:980px) {
  /* メインメニュー下段ボタン（スライドショー設定・抽選設定）の幅を上段と揃える */
#view-main .btn-row {
  display: flex;
  justify-content: space-between;
  gap: var(--gap);
  width: 100%;
  max-width: 600px;   /* ← 上段ボタンに合わせる */
  margin: 0 auto;
}

#view-main #btnGoSs,
#view-main #btnGoLottery {
  flex: 1 1 48%;       /* 横幅を均等に広げる */
  font-size: 24pt;
  min-height: 120px;   /* 高さを上段と揃える */
  white-space: nowrap; /* 改行させない */
}
  #view-main #btnGoSs{ font-size: calc(22pt * 0.8); } /* SSだけ80% */
}
  #view-main .btn-lottery{
  font-size:32pt;background:#fff;color:#000;padding:12px 36px;margin:12px 0;width:auto;
  position:relative; z-index:10; pointer-events:auto;
}
  #view-main .btn{border:none;border-radius:14px;cursor:pointer;font-weight:800;display:block}
  #view-main .btn-start{
  font-size:60pt;
  background:var(--blue);
  color:#000;
  padding:20px 60px;
  margin:12px 0;
  width: calc(100% - 80px); /* ← btn-layout と同じ幅に揃える */
  max-width: 600px;         /* 必要なら上限も指定 */
}
  #view-main .btn-layout{
  font-size:40pt;background:#fff;color:#000;padding:14px 40px;margin:12px 0;
  width:min(92vw, 800px);          /* ← 基準幅 */
  display:block; margin-left:auto; margin-right:auto;
}
  #view-main .btn-ss,
#view-main .btn-lottery{
  background:#fff;
  color:#000;
  margin:12px 0;
  width:auto;
  padding:12px 36px;              /* 同じ余白に統一 */
  min-height:80px;                /* ← 高さを同一にする基準 */
  display:flex;
  align-items:center;
  justify-content:center;
}
  #view-main .row{display:flex;flex-direction:row;align-items:center;gap:16px;margin:12px 0;flex-wrap:wrap}
  #view-main .row label{font-size:28pt}
  #view-main input[type="date"]{
    font-size:22pt;padding:6px 12px;border-radius:10px;border:1px solid var(--border);
    background:#0f0f0f;color:#fff;outline:none;
  }
  #view-main .btn-report{font-size:32pt;background:#fff;color:#000;padding:10px 30px}
  #view-main .row-pw{display:flex;align-items:center;gap:16px}
  #view-main .row-pw input{
    font-size:28pt;letter-spacing:.3em;text-align:center;width:220px;
    padding:6px 12px;border-radius:10px;border:1px solid var(--border);background:#0f0f0f;color:#fff;outline:none;
  }

  
/* ===== ④ レイアウト作成 ===== */
  #view-layout { position:relative; }
  #view-layout .wrap{min-height:100%;display:flex;flex-direction:column;gap:14px}
  #view-layout h1{font-size:18px;margin:0}
  #view-layout .room-name{font-size:42px;text-align:center;padding:4px 8px;border-radius:8px;border:1px solid #444;background:#0f0f0f;color:#eaeaea;width:min(800px,96vw);margin:0 auto;}
  #view-layout .grid{width:fit-content;margin:0 auto;background:#1b1b1b;border:1px solid #2a2a2a;padding:12px;border-radius:14px}
  #view-layout .cells{display:grid;gap:var(--gap);grid-template-columns:repeat(10,var(--cell));grid-template-rows:repeat(10,var(--cell))}
  #view-layout .cell{
  width:var(--cell);
  height:var(--cell);
  border-radius:8px;
  background:#fff;
  position:relative;
  user-select:none;
  /* iPad のタップ遅延を抑止 */
  touch-action: manipulation;
}
  #view-layout .st-wall{background:#000}
  #view-layout .st-hall{background:#fff}
  #view-layout .st-seat{background:#1e90ff}
  #view-layout .st-door{background:#90ee90}
  #view-layout .cell span{
    position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
    font-size:calc(var(--cell)*0.50);font-weight:900;color:#001a42;text-shadow:0 1px 0 rgba(255,255,255,.6);
    background:transparent;border-radius:0;padding:0;line-height:1;
  }
  #view-layout .cell .label{
    position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
    font-size:12px;font-weight:bold;color:#006400;background:rgba(255,255,255,0.7);padding:2px 4px;border-radius:4px
  }
  #view-layout .toolbar{display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
  #view-layout button{background:#fff;color:#000;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
  #view-layout button.ghost{background:#1f1f1f;color:#fff;border:1px solid #444}
  #view-layout .hint{color:#9aa0a6;text-align:center}
  #view-layout .back{
    position:absolute; right:16px; top:16px;
    border:1px solid var(--border);border-radius:10px;padding:8px 12px;background:#1b1b1b;color:#fff;cursor:pointer
  }

  /* ===== ⑤ 自習室開始（運用） ===== */
  #view-run .root{height:100%;display:flex;gap:12px}
  #view-run .left,#view-run .right{flex:1;min-width:0}
  #view-run .title{font-size:24px;margin:0 0 8px 0}
  #view-run .live-wrap{
    height:calc(100vh - 220px);
    background:#111;border:1px solid var(--border);border-radius:14px;padding:12px;
    display:flex;align-items:center;justify-content:center;
  }
  #view-run .live-grid{display:grid;gap:var(--gap)}
  #view-run .live-cell{width:var(--cell);height:var(--cell);border-radius:8px;position:relative;user-select:none;cursor:pointer}
  #view-run .live-wall{background:#000}
  #view-run .live-hall{background:#fff}
  #view-run .live-seat-empty{background:var(--blue)}
  #view-run .live-seat-busy{background:var(--pink)}
  #view-run .live-door{background:#90ee90}
  #view-run .seatno{
    position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
    font-size:calc(var(--cell)*0.50);font-weight:900;color:#001a42;text-shadow:0 1px 0 rgba(255,255,255,.6)
  }
  #view-run .doorTag{
    position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
    width:75%;height:75%;display:flex;align-items:center;justify-content:center;
    background:rgba(255,255,255,.7);color:#006400;font-weight:bold;border-radius:6px;
    font-size:clamp(10px, calc(var(--cell)*0.22), 18px);line-height:1;
  }
  #view-run .legend{margin-top:10px;display:flex;gap:16px;align-items:center;flex-wrap:wrap}
  #view-run .legend .box{display:inline-block;width:18px;height:18px;border-radius:4px;border:1px solid #666;margin-right:4px}
  #view-run .legend .lbl{font-size:14px;color:#cfcfcf}
  #view-run .right{display:flex;flex-direction:column;gap:24px;align-items:center}
  #view-run .clock{width:100%;height:20vh;display:flex;flex-direction:column;align-items:center;justify-content:center;border:1px solid var(--border);border-radius:14px;background:#0f0f0f;font-weight:700;letter-spacing:.05em}
  #view-run .clock .date{font-size:40px;margin-bottom:8px}
  #view-run .clock .time{font-size:64px}
  #view-run .btn-big{border:none;border-radius:14px;cursor:pointer;font-weight:800;padding:18px 40px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
  #view-run .btn-enter{background:var(--blue);color:var(--navy);font-size:48pt}
  #view-run .btn-leave{background:var(--pink);color:var(--red);font-size:48pt}
  #view-run .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  #view-run .btn-back{border:1px solid var(--border);border-radius:10px;padding:8px 12px;background:#1b1b1b;color:#fff;cursor:pointer}

  /* ダイアログ */
  .dialog{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50}
  .dialog .box{background:#1b1b1b;color:#fff;border:1px solid #2a2a2a;border-radius:14px;padding:18px;min-width:min(92vw,420px)}
  .dialog .rowx{display:flex;gap:8px;align-items:center;margin-top:10px}
  .dialog .box input{flex:1;border-radius:8px;border:1px solid #444;background:#0f0f0f;color:#eaeaea;padding:10px}
  .dialog .warn{color:#ffb74d;display:none;margin-top:8px}
  .dialog .btns{display:flex;gap:8px;justify-content:flex-end;margin-top:14px}
  .btn{border:1px solid var(--border);border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn.primary{background:#fff;color:#000}

  /* ===== 抽選設定のスタイル調整 ===== */
#view-lottery label {
  font-size: 2em;         /* 抽選設定内のラベル文字サイズ */
  line-height: 1.5;       /* 行間 */
}



#view-lottery input[type="number"],
#view-lottery input[type="text"] {
  height: 1.5em;
  font-size: 1em;
  width: 10em;             /* ← 横幅を固定 */
  box-sizing: border-box;
  padding: 4px 6px;
}

  /* ===== ⑥ 入室・退出（スキャン） ===== */
  #view-scan .page{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  #view-scan .main{display:grid;grid-template-columns:1fr 1fr;gap:16px;align-items:center}
  #view-scan .stage{min-height:60vh;background:#0f0f0f;border:1px solid var(--border);border-radius:14px;position:relative;padding:12px;display:flex;align-items:center;justify-content:flex-start;overflow:hidden}
  #view-scan .stage-inner{width:80%;max-width:80%;position:relative;display:flex;align-items:center;justify-content:center}
  #view-scan video{width:100%;height:auto;display:block;border-radius:12px;background:#000;object-fit:cover;max-height:70vh}
  #view-scan .overlay{position:absolute;pointer-events:none}
  #view-scan .guide{position:absolute;border:3px solid rgba(79,195,247,0.9);border-radius:12px;box-shadow:0 0 0 200vmax rgba(0,0,0,.25) inset}
  #view-scan .id-panel{display:flex;flex-direction:column;align-items:center;gap:14px;background:#0f0f0f;border:1px solid var(--border);border-radius:14px;padding:18px;min-height:60vh;justify-content:center}
  #view-scan .id-title{font-size:28px;font-weight:700}
  #view-scan .id-input{font-size:40pt;line-height:1;width:min(90%,22ch);padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:#050505;color:#fff;text-align:center;letter-spacing:.02em}
  #view-scan .id-input::placeholder{color:#9aa0a6}
  #view-scan .btn-ok{font-size:28px;font-weight:800;padding:10px 24px;border-radius:12px;background:var(--blue);color:#001a42;cursor:pointer}
  #view-scan .status{text-align:center;font-size:16px;color:#9aa0a6}
  #view-scan .result{text-align:center;font-size:22px;font-weight:700;color:#000;background:var(--blue);padding:10px 14px;border-radius:12px;width:min(92vw,900px);margin:0 auto;display:none}

  /* モーダル(スキャン) */
  #confirmDlg{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:60}
  #confirmDlg .cbox{background:#1b1b1b;border:1px solid #2a2a2a;border-radius:20px;padding:36px;min-width:min(92vw,760px)}
  #confirmDlg .msg{font-size:36px;margin-bottom:24px}
  #confirmDlg .btns .btn{font-size:24px;padding:12px 20px}

  #assignDlg{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:65}
  #assignDlg .cbox{background:#1b1b1b;border:1px solid #2a2a2a;border-radius:20px;padding:36px;min-width:min(92vw,720px)}
  #assignDlg .msg{font-size:36px;margin-bottom:24px}
  #assignDlg .btns .btn{font-size:24px;padding:12px 20px}

  #infoDlg{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:70}
  #infoDlg .cbox{background:#1b1b1b;border:1px solid #2a2a2a;border-radius:20px;padding:28px;min-width:min(92vw,560px)}
  #infoDlg .msg{font-size:28px;margin-bottom:18px}
  #infoDlg .btns .btn{font-size:20px;padding:10px 18px}

  /* ======= スライドショー（全画面） ======= */
  #ssOverlay{position:fixed;inset:0;background:#000;display:none;align-items:center;justify-content:center;z-index:9999;cursor:none;pointer-events:none}
  #ssStage{position:relative;width:100vw;height:100vh;overflow:hidden;background:#000}
  .ssLayer{position:absolute;inset:0;opacity:0;transition:opacity 1200ms ease}
  .ssLayer.show{opacity:1}
  .ssImg, .ssVid{position:absolute;top:50%;left:50%;transform-origin:center center;will-change:transform,opacity}
  /* 動画も常に画面内に収める（はみ出さない） */
.ssVid{width:100vw;height:100vh;object-fit:contain;transform:translate(-50%,-50%)}
  .ssImg{width:100vw;height:100vh;object-fit:contain;transform:translate(-50%,-50%)}

  /* レスポンシブ */
  @media (max-width:980px){
    #view-title .title{font-size:64pt}
    #view-title .inline-row{grid-template-columns:1fr}
    #view-title .inline-label{font-size:28pt}
    #view-main .title{font-size:28pt}
    #view-main .btn-start{font-size:36pt;padding:16px 36px}
    #view-main .btn-layout,#view-main .btn-report,#view-main .btn-ss,#view-main .btn-lottery{font-size:26pt}
    #view-main .row label{font-size:22pt}
    #view-main input[type="date"]{font-size:18pt}
    #view-main .row-pw input{font-size:22pt;width:180px}
    #view-layout .room-name{font-size:28px}
    #view-run .root{flex-direction:column}
    #view-run .clock .date{font-size:28px}
    #view-run .clock .time{font-size:48px}
    #view-run .btn-enter,#view-run .btn-leave{font-size:36pt}
    #view-scan .main{grid-template-columns:1fr}
    #view-scan .stage-inner{width:100%;max-width:100%}
    #confirmDlg .cbox, #assignDlg .cbox{min-width:min(96vw,640px);padding:28px}
    #confirmDlg .btns .btn, #assignDlg .btns .btn{font-size:20px}
  }

  /* スライドショー設定：チェックボックス拡大 */
  #ssEnabled { transform: scale(2); margin-right: 12px; vertical-align: middle; }
  #view-ss label { font-size: 2em; }

  /* BGMピッカー */
  #bgmPicker .box{min-width:min(92vw,900px)}
  #bgmPicker table{width:100%;border-collapse:collapse;background:#0f0f0f;border:1px solid #333;border-radius:10px;overflow:hidden}
  #bgmPicker th,#bgmPicker td{padding:10px;border-bottom:1px solid #222;text-align:left}
  #bgmPicker th{background:#151515}
  #bgmPicker .right{text-align:right}
  #bgmPicker .center{text-align:center}
  #bgmPicker .muted{color:#9aa0a6}
  #bgmPicker .btns{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
  #bgmPicker .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  #bgmPicker .header .title{font-size:20px;font-weight:700}
  #bgmPicker .pick-row{cursor:pointer}
  #bgmPicker .pick-row:hover{background:#1a1a1a}
/* ＋／ー スピンボタン */
.spinbtn{
  border:1px solid var(--border);border-radius:8px;background:#1b1b1b;color:#fff;
  font-weight:800;cursor:pointer;line-height:1;min-width:2.4em;height:2.2em
}
.spinwrap{display:flex;align-items:center;gap:8px}
.spinwrap input[type="number"]{width:120px}

/* ===== 抽選設定：フォント半分＋行間1.5 ===== */
#view-lottery { font-size:50%; line-height:1.5; }



/* 入力枠の高さは1.5倍、幅は3桁程度が収まるよう調整 */
#view-lottery input[type="text"],
#view-lottery input[type="number"] {
  font-size: 1em;      /* ベースフォント */
  line-height: 1.5em;  /* 高さ1.5倍 */
  padding: 0.25em;     /* 少し余白 */
  width: 4ch;          /* 約3〜4桁分の幅 */
}

/* 行の余白は少し広げる */
#view-lottery .row { gap: 1em; }
/* ===== 抽選設定（レスポンシブ調整・上書き） ===== */
#view-lottery{
  /* ページ全体の文字をやや小さめに（端末幅に追随） */
  font-size: clamp(13px, 1.6vw, 16px);
}
#view-lottery .wrap{
  max-width: min(1100px, 96vw);
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  gap: 14px;
}
#view-lottery h1{
  /* 見出しは控えめに */
  font-size: clamp(18px, 2.2vw, 26px);
  line-height: 1.25;
  margin: 0 0 6px;
}
#view-lottery .card{
  width: 100%;                /* 枠の幅を統一（wrap=中央寄せの基準） */
  margin: 0 auto;             /* 左右位置を中央に固定 */
  background:#111;
  border:1px solid var(--border);
  border-radius:14px;
  padding:14px;
}

/* 各行はグリッドで整列（小さな画面では自動折返し） */
#view-lottery .row{
  display: grid;
  grid-template-columns: auto auto 1fr auto auto auto;
  /* [チェック] [ラベル] [名称入力(広め)] [出現率ラベル] [入力(短め)] [補助テキスト] */
  gap: 10px 12px;
  align-items: center;
  line-height: 1.25;        /* 行間：文字サイズの約1/1.25 ≒ 0.8〜0.9倍 */
  padding: 6px 0;
}
#view-lottery .row > label{ min-width: auto; white-space: nowrap; }

/* スマホでは縦に崩れすぎないよう段組みを変更 */
@media (max-width: 860px){
  #view-lottery .row{
    grid-template-columns: auto auto 1fr auto auto;
    grid-auto-rows: auto;
  }
}



/* 入力枠は既存より“高さ1.5倍相当”に */
#view-lottery input[type="text"],
#view-lottery input[type="number"]{
  font-size: 1em;
  height: 2.4em;        /* 高め */
  padding: 0.4em 0.6em;
  border-radius: 10px;
  border:1px solid var(--border);
  background:#0f0f0f;color:#fff;
  box-sizing: border-box;
}

/* 名称の入力は広め、出現率などの数値は“3桁程度”の幅に短縮 */
#view-lottery input[id^="lotName"]{ min-width: 18ch; }

/* 抽選出現率と各アタリのレート欄を短く */
#view-lottery #lotteryEvery,
#view-lottery input[id^="lotRate"]{
  width: 7ch;           /* 3桁＋α */
  min-width: 7ch;
}

/* スピンボタンと合わせて狭い面積で配置 */
#view-lottery .spinwrap{ gap: 8px; }
#view-lottery .spinwrap input[type="number"]{ width: 7ch; }

/* 「当選確率」など補助文言のトーン */
#view-lottery .unit, 
#view-lottery .lotProb{ color:#cfcfcf; white-space: nowrap; }

/* 右寄せボタン行の折返し対策 */
#view-lottery .row.right{
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  flex-wrap: wrap;
}

/* 画面が極端に狭い場合の保険 */
@media (max-width: 520px){
  #view-lottery .row{
    grid-template-columns: auto 1fr auto auto; /* 可能な限り簡素化 */
  }
  #view-lottery input[id^="lotName"]{ min-width: 12ch; }
}
/* 抽選設定チェックボックス：スライドショー設定と同じ */
#view-lottery input[type="checkbox"] {
  transform: scale(2);
  margin-right: 12px;
  vertical-align: middle;
}
/* 抽選設定：ラベルと入力欄の間隔を詰める */
#view-lottery .row label {
  min-width: auto;      /* 固定幅を解除 */
  margin-right: 4px;    /* 少しだけ余白を残す */
  font-size: 1em;
  line-height: 1.5;
}

#view-lottery .row input[type="text"] {
  flex: 1;              /* 可能な範囲で広がる */
  width: auto;          /* 幅を固定せずに自然に配置 */
}

/* ── 抽選設定（#view-lottery） 行間を詰める ───────────────── */
#view-lottery .row{
  display:flex;
  align-items:center;
  gap:4px;           /* ← ラベルと入力枠の“間”を最小限に */
  flex-wrap:wrap;
}
/* 「名称」など行内の短いテキストの直後の余白を小さめに */
#view-lottery .row span{ margin-right:2px; }

/* 入力枠の縦サイズは従来そのまま（※高さは前回指定を維持）*/
/* 幅は詰めたい行の折返しを防ぐため、必要に応じて短め */
#view-lottery input[type="text"],
#view-lottery input[type="number"]{
  /* もし広すぎて改行する場合は下の width を有効化（例：8〜10ch） */
  /* width: 9ch; */
}

/* ───────────────────────────────────────────── */
/* ==== 抽選設定（#view-lottery）最終上書き ==== */
#view-lottery { font-size: clamp(13px, 1.6vw, 16px); }
#view-lottery .card{ background:#111;border:1px solid var(--border);border-radius:14px;padding:14px; }

/* 行は詰めて横並び（小画面では自動折返し） */
#view-lottery .row{
  display:flex;
  align-items:center;
  gap:6px;            /* “名称”と入力枠の間を最小限に */
  flex-wrap:wrap;
}

/* チェックボックスはスライドショー設定と同じ大きさに統一 */
#view-lottery input[type="checkbox"]{
  transform: scale(2);
  margin-right: 10px;
  vertical-align: middle;
}

/* 入力の高さは約1.5倍相当（触りやすく） */
#view-lottery input[type="text"],
#view-lottery input[type="number"]{
  height: 2.4em;
  padding: 0.4em 0.6em;
  border-radius: 10px;
  border:1px solid var(--border);
  background:#0f0f0f;color:#fff;
  box-sizing: border-box;
}

#view-lottery input[id^="lotName"]{
  flex: 0 0 24ch !important;   /* ← 伸びない＆基準幅を12chに固定 */
  width: 24ch !important;
  min-width: 24ch !important;
  max-width: 24ch !important;
}

/* 抽選出現率と各アタリの数値欄：3桁程度の幅に */
#view-lottery #lotteryEvery,
#view-lottery input[id^="lotRate"]{
  width: 7ch;
  min-width: 7ch;
}
</style>
</head>
<body>

<!-- ===== ① タイトルメニュー ===== -->
<section id="view-title" class="container">
  <div class="title">自習室管理</div>
  <div class="login-inline" aria-label="教室ログイン">
    <div class="inline-row">
      <div class="inline-label">教室ID</div>
      <input id="roomIdTop" class="inline-input" type="text" placeholder="教室IDを入力" />
    </div>
    <div class="inline-row">
      <div class="inline-label">password</div>
      <input id="roomPwTop" class="inline-input" type="password" placeholder="password を入力" />
    </div>
    <button type="button" class="login-btn" id="btnTitleLogin">ログイン</button>
  </div>
</section>

<!-- ===== ② スライドショー設定 ===== -->
<section id="view-ss" class="container hidden">
  <div class="wrap">
    <h1>スライドショー設定</h1>

    <div class="card">
      <div class="row">
        <label><input type="checkbox" id="ssEnabled"> 有効</label>
      </div>
      <div class="row">
        <label for="ssIdleMin">無操作で起動（分）</label>
        <input id="ssIdleMin" type="number" min="1" max="120" step="1" />
      </div>
      <div class="row">
        <label for="ssDuration">1枚の表示（秒）</label>
        <input id="ssDuration" type="number" min="3" max="120" step="1" />
      </div>
    </div>

    <div class="card">
      <div class="file-row">
        <label>写真・動画（複数可）</label>
        <div>
          <input id="ssFiles" type="file" accept="image/*,video/mp4,video/webm" multiple />
          <button id="clearMedia" class="btn ghost push-right">選択を解除</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="file-row">
        <label>BGM</label>
        <div>
          <button id="btnPickBgm" class="btn ghost">BGMを選ぶ</button>
          <span class="note">選択中：</span>
          <span id="bgmNow" class="note">（未選択）</span>
          <button id="clearBgm" class="btn ghost push-right">選択を解除</button>
        </div>
      </div>
    </div>

    <div class="row right">
      <button class="btn ghost" id="btnSsBack">戻る</button>
      <button class="btn primary" id="btnSsSave">保存</button>
      <button class="btn primary" id="btnSsTest">テスト</button>
    </div>
  </div>
</section>

<!-- ===== 抽選設定（新規） ===== -->
<section id="view-lottery" class="container hidden">
  <div class="wrap">
    <h1 style="font-size:200%; line-height:1.5;">抽選設定</h1>

    <div class="card">
<div class="row">
  <input id="lotteryEnabled" type="checkbox" style="margin-right:12px">
<label for="lotteryEnabled">有効</label>
  <label>抽選出現率</label>
  <div class="spinwrap">
    <button class="spinbtn" data-target="lotteryEvery" data-step="-10">−10</button>
    <input id="lotteryEvery" type="number" value="100">
    <button class="spinbtn" data-target="lotteryEvery" data-step="10">＋10</button>
  </div>
  <span>回に1回出現</span>
</div>
    </div>

    <!-- ▼ ここから追加（チェックボックス + アタリ01〜10） -->
<div class="card" aria-label="アタリ拡張設定">
  <!-- アタリ01 -->
  <div class="row">
    <input id="lotOn01" type="checkbox" class="lotchk">
    <label style="min-width:auto;margin-right:8px">アタリ01</label>
    <span>名称</span>
    <input id="lotName01" type="text" placeholder="例：文房具セット" />
    <span>　　本数</span>
    <input id="lotRate01" type="number" min="0" step="1" inputmode="numeric">
<span class="lotProb">　　当選確率 0％</span>
  </div>
  <!-- アタリ02 -->
  <div class="row">
    <input id="lotOn02" type="checkbox" class="lotchk">
    <label style="min-width:auto;margin-right:8px">アタリ02</label>
    <span>名称</span>
    <input id="lotName02" type="text"  />
    <span>　　本数</span>
    <input id="lotRate02" type="number" min="0" step="1" inputmode="numeric">
<span class="lotProb">　　当選確率 0％</span>
  </div>
  <!-- アタリ03 -->
  <div class="row">
    <input id="lotOn03" type="checkbox" class="lotchk">
    <label style="min-width:auto;margin-right:8px">アタリ03</label>
    <span>名称</span>
    <input id="lotName03" type="text"  />
    <span>　　本数</span>
    <input id="lotRate03" type="number" min="0" step="1" inputmode="numeric">
<span class="lotProb">　　当選確率 0％</span>
  </div>
  <!-- アタリ04 -->
  <div class="row">
    <input id="lotOn04" type="checkbox" class="lotchk">
    <label style="min-width:auto;margin-right:8px">アタリ04</label>
    <span>名称</span>
    <input id="lotName04" type="text"  />
    <span>　　本数</span>
    <input id="lotRate04" type="number" min="0" step="1" inputmode="numeric">
<span class="lotProb">　　当選確率 0％</span>
  </div>
  <!-- アタリ05 -->
  <div class="row">
    <input id="lotOn05" type="checkbox" class="lotchk">
    <label style="min-width:auto;margin-right:8px">アタリ05</label>
    <span>名称</span>
    <input id="lotName05" type="text"  />
    <span>　　本数</span>
    <input id="lotRate05" type="number" min="0" step="1" inputmode="numeric">
<span class="lotProb">　　当選確率 0％</span>
  </div>
  <!-- アタリ06 -->
  <div class="row">
    <input id="lotOn06" type="checkbox" class="lotchk">
    <label style="min-width:auto;margin-right:8px">アタリ06</label>
    <span>名称</span>
    <input id="lotName06" type="text"  />
    <span>　　本数</span>
    <input id="lotRate06" type="number" min="0" step="1" inputmode="numeric">
<span class="lotProb">　　当選確率 0％</span>
  </div>
  <!-- アタリ07 -->
  <div class="row">
    <input id="lotOn07" type="checkbox" class="lotchk">
    <label style="min-width:auto;margin-right:8px">アタリ07</label>
    <span>名称</span>
    <input id="lotName07" type="text"  />
    <span>　　本数</span>
    <input id="lotRate07" type="number" min="0" step="1" inputmode="numeric">
<span class="lotProb">　　当選確率 0％</span>
  </div>
  <!-- アタリ08 -->
  <div class="row">
    <input id="lotOn08" type="checkbox" class="lotchk">
    <label style="min-width:auto;margin-right:8px">アタリ08</label>
    <span>名称</span>
    <input id="lotName08" type="text"  />
    <span>　　本数</span>
    <input id="lotRate08" type="number" min="0" step="1" inputmode="numeric">
<span class="lotProb">　　当選確率 0％</span>
  </div>
  <!-- アタリ09 -->
  <div class="row">
    <input id="lotOn09" type="checkbox" class="lotchk">
    <label style="min-width:auto;margin-right:8px">アタリ09</label>
    <span>名称</span>
    <input id="lotName09" type="text"  />
    <span>　　本数</span>
    <input id="lotRate09" type="number" min="0" step="1" inputmode="numeric">
<span class="lotProb">　　当選確率 0％</span>
  </div>
  <!-- アタリ10 -->
  <div class="row">
    <input id="lotOn10" type="checkbox" class="lotchk">
    <label style="min-width:auto;margin-right:8px">アタリ10</label>
    <span>名称</span>
    <input id="lotName10" type="text"  />
    <span>　　本数</span>
    <input id="lotRate10" type="number" min="0" step="1" inputmode="numeric">
<span class="lotProb">　　当選確率 0％</span>
  </div>
</div>
<!-- ▲ ここまで追加 -->

<div class="row right">
  <button class="btn ghost" id="btnLotteryBack">戻る</button>
  <button class="btn primary" id="btnLotteryLoad">呼出</button>
  <button class="btn primary" id="btnLotterySave">保存</button>
  <input id="lotteryOpenFile" type="file" accept=".json,application/json" style="display:none" />
</div>
  </div>
</section>

<!-- ===== ③ メインメニュー ===== -->
<section id="view-main" class="container hidden">
  <div class="wrap">
    <h1 class="title">自習室管理メインメニュー</h1>

    <button type="button" class="btn btn-start" id="btnGoRun">自習室開始</button>
<button type="button" class="btn btn-layout" id="btnGoLayout">レイアウト作成</button>
<div class="btn-row">
  <button type="button" class="btn btn-ss" id="btnGoSs" onclick="gotoSs()">スライドショー設定</button>
<button type="button" class="btn btn-lottery" id="btnGoLottery" onclick="gotoLottery()">抽選設定</button>
</div>

    

    <div class="row row-pw">
      <label>ロック解除パスワード</label>
      <input id="unlockPwMain" type="text" maxlength="4" pattern="[0-9]*" inputmode="numeric" />
    </div>
  </div>
</section>



<!-- ===== ④ レイアウト作成 ===== -->
<section id="view-layout" class="container hidden">
  <button class="back" onclick="gotoMain()">メインメニューに戻る</button>

  <div class="wrap">
    <h1>自習室レイアウト作成</h1>
    <input id="roomName" class="room-name" placeholder="自習室の名称を入力" />
    <div class="grid">
      <div id="cells" class="cells" role="grid" aria-label="レイアウト 10×10"></div>
    </div>
    <div class="toolbar">
      <button id="allWall" class="ghost">全て壁</button>
      <button id="allHall" class="ghost">全て廊下</button>
      <button id="saveBtn">名前を付けて保存</button>
      <button id="openBtn" class="ghost">ファイルを開く</button>
      <input id="fileOpen" type="file" accept=".json,application/json" style="display:none" />
    </div>
    <div class="hint">左クリック：壁（黒）→ 廊下（白）→ 入口（薄緑）／ 長押し（右クリック相当）：座席（青）＋番号入力</div>
  </div>
</section>

<!-- ===== ⑤ 自習室開始（運用） ===== -->
<section id="view-run" class="container hidden">
  <div class="topbar">
    <h3 id="runRoomTitle" class="title">自習室</h3>
    <button class="btn-back" onclick="backToMainFromRun()">メインメニューに戻る</button>
  </div>

  <div class="root">
    <section class="left">
      <div id="liveWrap" class="live-wrap">
        <div id="liveGrid" class="live-grid" aria-label="現在のレイアウト"></div>
      </div>
      <div class="legend">
        <span class="box" style="background:#4fc3f7"></span><span class="lbl">空席</span>
        <span class="box" style="background:#ffc0cb"></span><span class="lbl">利用中</span>
      </div>
    </section>

    <section class="right" aria-label="操作">
      <div class="clock">
        <div id="dateText" class="date">----/--/--（-）</div>
        <div id="timeText" class="time">--:--</div>
      </div>
      <button class="btn-big btn-enter" onclick="openScan('enter')">入 室</button>
      <button class="btn-big btn-leave" onclick="openScan('leave')">退 室</button>
    </section>
  </div>
</section>

<!-- 座席操作ダイアログ（run） -->
<div id="dlgSeatOps" class="dialog" role="dialog" aria-modal="true" aria-label="座席操作">
  <div class="box">
    <div class="rowx">
      <label style="min-width:9em">ロック解除パスワード</label>
      <input id="unlockPwOps" type="password" placeholder="" maxlength="4" inputmode="numeric" />
    </div>
    <div style="font-weight:700;margin-top:8px;display:flex;align-items:center;gap:8px">
      <span>座席操作</span>
      <span id="seatOpsUsage" style="color:#ccc;font-size:0.95em"></span>
    </div>
    <div class="rowx">
      <label style="min-width:6em">座席移動</label>
      <input id="moveToSeat" type="text" placeholder="座席No.を入力">
    </div>
    <div class="btns" style="justify-content:flex-start">
      <button id="opsCancel" class="btn">閉じる</button>
      <button id="opsOk" class="btn primary">座席移動</button>
      <button id="btnDoLeave" class="btn">退席処理</button>
    </div>
    <div id="opsWarn" class="warn">パスワードが正しくありません。</div>
  </div>
</div>

<!-- ===== ⑥ 入室・退出（スキャン） ===== -->
<section id="view-scan" class="container hidden">
  <header class="page">
    <h1 id="scanTitle">QRスキャン</h1>
    <button class="btn" onclick="backFromScan()">戻る</button>
  </header>

  <div class="main">
    <div class="stage">
      <div class="stage-inner" id="stageInner">
        <video id="video" playsinline autoplay muted></video>
        <div id="overlay" class="overlay"><div id="guide" class="guide" aria-hidden="true"></div></div>
      </div>
    </div>

    <div class="id-panel">
      <div class="id-title">利用ID入力</div>
      <input id="idInput" class="id-input" type="text" placeholder="例：12345678" inputmode="numeric" maxlength="15" aria-label="利用IDを入力"/>
      <button id="okBtn" class="btn-ok">完 了</button>
      <div id="okNote" class="status" style="display:none;"></div>
    </div>
  </div>

  <div id="status" class="status">カメラを起動しています…</div>
  <div id="result" class="result" role="alert" aria-live="assertive"></div>
  <div class="controls" style="display:flex;gap:10px;justify-content:center;margin-top:6px">
    <button id="restart" class="btn hidden">もう一度スキャン</button>
    <button id="switchCam" class="btn hidden">カメラ切替</button>
  </div>
  <div id="err" class="status" style="color:#ff2d55"></div>
</section>



<!-- 座席割当モーダル（入室OK後） -->
<div id="assignDlg" role="dialog" aria-modal="true" aria-label="座席割当" style="display:none; align-items:center; justify-content:center;">
  <div class="cbox">
    <div id="assignMsg" class="msg">No.?? の座席を利用してください。</div>
    <div class="btns" style="display:flex;gap:10px;justify-content:flex-end">
      <button id="assignCancel" class="btn">キャンセル</button>
      <button id="assignOk" class="btn primary">OK</button>
    </div>
  </div>
</div>

<!-- 退室時：情報モーダル -->
<div id="infoDlg" role="dialog" aria-modal="true" aria-label="情報" style="display:none; align-items:center; justify-content:center;">
  <div class="cbox">
    <div id="infoMsg" class="msg">このIDは利用中ではありません。</div>
    <div class="btns" style="display:flex;gap:10px;justify-content:flex-end">
      <button id="infoOk" class="btn primary">OK</button>
    </div>
  </div>
</div>

<!-- ===== スライドショー オーバーレイ ===== -->
<div id="ssOverlay">
  <div id="ssStage">
    <div id="ssLayerA" class="ssLayer"></div>
    <div id="ssLayerB" class="ssLayer"></div>
  </div>
</div>

<!-- ===== BGM ピッカーダイアログ ===== -->
<div id="bgmPicker" class="dialog" role="dialog" aria-modal="true" aria-label="BGMを選択">
  <div class="box">
    <div class="header">
      <div class="title">BGMを選択（BGM管理アプリ）</div>
      <div id="bgmPickMsg" class="muted"></div>
    </div>
    <div style="margin-bottom:8px;display:flex;gap:8px;align-items:center">
      <button id="bgmReload" class="btn">更新</button>
      <span class="muted">ダブルクリック、または行の「試聴」で再生。</span>
    </div>
    <div style="max-height:50vh;overflow:auto;border:1px solid #333;border-radius:10px">
      <table>
        <thead>
  <tr>
    <th style="width:60px" class="center">選択</th>
    <th>Title</th>
    <th style="width:120px" class="right">DURATION</th>
    <th style="width:120px" class="center">操作</th>
  </tr>
</thead>
        <tbody id="bgmTbody">
  <tr><td colspan="4" class="center muted">読み込み中…</td></tr>
</tbody>
      </table>
    </div>
    <div style="margin-top:8px">
      <audio id="bgmPreview" controls preload="none" style="width:100%"></audio>
    </div>
    <div class="btns" style="margin-top:10px">
      <button id="bgmCancel" class="btn">キャンセル</button>
      <button id="bgmOk" class="btn primary">決 定</button>
    </div>
  </div>
</div>

<!-- jsQR（1回だけ） -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

<script>
/* ===== 固定：BGM管理アプリ Functions ベースURL ===== */
const BGM_API_BASE = 'https://superlative-bienenstitch-e300de.netlify.app/.netlify/functions';
/* ===== 固定：BGM管理アプリ Functions ベースURL ===== */
const BGM_SITE   = 'https://superlative-bienenstitch-e300de.netlify.app';
const BGM_FN_BASE = `${BGM_SITE}/.netlify/functions`;

/* ===== 共通キー・ユーティリティ ===== */
const KEY_LAYOUT='studyroom-layout-v7', KEY_NAME='studyroom-name-v7', KEY_UNLOCK='unlock-pw';
const KEY_HISTORY='usage-history-v1';
const KEY_ROOM_PREFIX='room-id-prefix';
const SIZE=10;
function $(id){return document.getElementById(id);}
function show(id){
  document.querySelectorAll('section.container').forEach(s=>s.classList.add('hidden'));
  $(id).classList.remove('hidden');
}
function fmt2(n){ return String(n).padStart(2,'0'); }
function toDateStr(d){ return `${d.getFullYear()}-${fmt2(d.getMonth()+1)}-${fmt2(d.getDate())}`; }
function toDisp(d){ return `${d.getFullYear()}/${fmt2(d.getMonth()+1)}/${fmt2(d.getDate())} ${fmt2(d.getHours())}:${fmt2(d.getMinutes())}`; }
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* ===== 画面遷移 ===== */
function gotoTitle(){ stopCamera(); show('view-title'); }
function gotoMain(){ stopCamera(); show('view-main'); }
function gotoLayout(){ stopCamera(); renderEditor(); show('view-layout'); }
function gotoRun(){
  stopCamera();
  show('view-run');
  requestAnimationFrame(()=>{
    renderRun();
    setTimeout(forceRunFit, 60);
  });
}
function gotoSs(){ stopCamera(); loadSsSettingsUI(); show('view-ss'); }
function forceRunFit(){
  const liveGrid=$('liveGrid');
  const cs=getComputedStyle(liveGrid);
  const cols=cs.gridTemplateColumns.split(' ').length||1;
  const rows=cs.gridTemplateRows.split(' ').length||1;
  fitCellSize(cols, rows);
}

/* ===== 抽選設定：遷移＆保存 ===== */
const LOTTERY_KEY = 'lottery.settings.v1';

function gotoLottery(){ 
  stopCamera(); 
  loadLotteryUI(); 
  show('view-lottery'); 
}

function loadLottery(){
  try{ return JSON.parse(localStorage.getItem(LOTTERY_KEY) || '{}'); }catch{ return {}; }
}

function saveLottery(obj){
  localStorage.setItem(LOTTERY_KEY, JSON.stringify(obj));
}

function loadLotteryUI(){
  const s = loadLottery();
  $('lotteryEnabled').checked = !!s.enabled;
  $('lotteryEvery').value = Number.isFinite(s.every) && s.every >= 1 ? s.every : 10; // 既定値10
}

/* UIイベント */
const btnLotteryBack = $('btnLotteryBack');
if (btnLotteryBack) btnLotteryBack.addEventListener('click', gotoMain);

/* 抽選設定をUIから収集 → オブジェクト化 */
function collectLotterySettings(){
  const s = {
    enabled: $('lotteryEnabled').checked,
    every: parseInt($('lotteryEvery').value, 10) || 1,
    items: []
  };
  for (let i = 1; i <= 10; i++) {
    const idx2 = String(i).padStart(2,'0');
    s.items.push({
      on: !!$('lotOn'+idx2)?.checked,
      name: ($('lotName'+idx2)?.value ?? ''),
      // 「出現率」を「本数」に変更済みだが、既存ID lotRateXX を流用
      rate: parseInt($('lotRate'+idx2)?.value ?? '0', 10) || 0
    });
  }
  return s;
}

/* 抽選設定オブジェクトをUIに反映 */
function applyLotterySettings(s){
  try{
    $('lotteryEnabled').checked = !!s.enabled;
    $('lotteryEvery').value = Number.isFinite(s.every) && s.every >= 1 ? s.every : 1;
    if (Array.isArray(s.items)){
      for (let i = 1; i <= 10; i++){
        const idx2 = String(i).padStart(2,'0');
        const it = s.items[i-1] || {};
        if ($('lotOn'+idx2))   $('lotOn'+idx2).checked = !!it.on;
        if ($('lotName'+idx2)) $('lotName'+idx2).value   = it.name ?? '';
        if ($('lotRate'+idx2)) $('lotRate'+idx2).value   = Number.isFinite(it.rate) ? it.rate : 0;
      }
    }
    // 既存の比率表示更新（名称は変わったが再計算は動かしておく）
    if (typeof updateLotPercentage === 'function') updateLotPercentage();
  }catch(e){
    alert('設定の反映に失敗しました: ' + (e?.message || e));
  }
}

/* 保存：抽選設定をローカル（ダウンロード） */
const btnLotterySave = $('btnLotterySave');
if (btnLotterySave) btnLotterySave.addEventListener('click', ()=>{
  const s = collectLotterySettings();
  const json = JSON.stringify(s, null, 2);

  const now = new Date();
  const y = now.getFullYear();
  const m = String(now.getMonth()+1).padStart(2,'0');
  const d = String(now.getDate()).padStart(2,'0');
  const fileName = `${y}-${m}-${d}抽選設定.json`;

  const blob = new Blob([json], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = fileName;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);

  // 必要ならローカルストレージにも保持
  try{ saveLottery(s); }catch{}
});

/* 呼出：保存したJSONを読み込んで画面に適用 */
const btnLotteryLoad = $('btnLotteryLoad');
const lotteryOpenFile = $('lotteryOpenFile');

if (btnLotteryLoad && lotteryOpenFile){
  btnLotteryLoad.addEventListener('click', ()=> lotteryOpenFile.click());

  lotteryOpenFile.addEventListener('change', async (e)=>{
    const f = e.target.files && e.target.files[0];
    if (!f) return;
    try{
      const text = await f.text();
      const s = JSON.parse(text);
      // ざっくりバリデーション
      if (!s || typeof s !== 'object' || !('enabled' in s)) {
        throw new Error('抽選設定の形式ではありません');
      }
      applyLotterySettings(s);
      // 任意：読み込んだ内容をストレージにも保存
      try{ saveLottery(s); }catch{}
      alert('抽選設定を読み込みました');
    }catch(err){
      alert('読み込みに失敗しました: ' + (err?.message || err));
    }finally{
      e.target.value = '';
    }
  });
}

// ＋／ー スピンボタン（抽選出現率を整数で増減）
document.addEventListener('click', (e)=>{
  const b = e.target.closest('.spinbtn');
  if(!b) return;
  const target = $(b.dataset.target);
  if(!target) return;
  const step = Number(b.dataset.step||1);
  let v = Math.floor(Number(target.value||0));
  if(!Number.isFinite(v)) v = 0;
  v += step;
  // 抽選出現率は 1 以上に制限
  if (target.id === 'lotteryEvery') {
    v = Math.max(1, v);
  }
  target.value = v;
  // 入力イベントを発火（必要に応じて他の連動処理が走る）
  target.dispatchEvent(new Event('input', {bubbles:true}));
});

// 手入力も整数化＋最小値1に補正
(function(){
  const el = $('lotteryEvery');
  if(!el) return;
  const fix = ()=>{
    if(el.value === '') return;
    const v = Math.max(1, Math.floor(Number(el.value)));
    el.value = Number.isFinite(v) ? v : 1;
  };
  el.addEventListener('input', fix);
  el.addEventListener('change', fix);
})();

// ===== 当選確率の自動計算 =====
function updateLotPercentage(){
  const rates = [];
  let sum = 0;
  for (let i = 1; i <= 10; i++){
    const idx2 = String(i).padStart(2,'0');
    const on = document.getElementById(`lotOn${idx2}`);
    const rateEl = document.getElementById(`lotRate${idx2}`) || document.getElementById(`lotRate${i}`);
    const val = rateEl ? parseFloat(rateEl.value) : NaN;
    const enabled = on ? on.checked : true; // チェックボックスが無ければtrue扱い
    rates[i] = enabled && !isNaN(val) && val > 0 ? val : 0;
    sum += rates[i];
  }
  // 画面表示を更新
  const probEls = document.querySelectorAll('#view-lottery .lotProb');
  probEls.forEach((el, idx) => {
    const i = idx + 1;
    const val = rates[i] || 0;
    el.textContent = (!sum || val === 0)
      ? '当選確率 —'
      : `当選確率 ${(val / sum * 100).toFixed(1)}％`;
  });
}

// チェック／入力が変わったら再計算
for (let i = 1; i <= 10; i++){
  const idx2 = String(i).padStart(2,'0');
  const on = document.getElementById(`lotOn${idx2}`);
  const rateEl = document.getElementById(`lotRate${idx2}`) || document.getElementById(`lotRate${i}`);
  if (on) on.addEventListener('change', updateLotPercentage);
  if (rateEl) rateEl.addEventListener('input', updateLotPercentage);
}
document.addEventListener('DOMContentLoaded', updateLotPercentage);

/* ===== タイトル → メイン ===== */
const loginBtn = $('btnTitleLogin');
if (loginBtn) {
  loginBtn.addEventListener('click', ()=>{
    const rid = ($('roomIdTop')?.value||'').trim();
    const pw  = ($('roomPwTop')?.value||'').trim();
  if(!rid || rid.length<3){ alert('教室ID（先頭3桁以上）を入力してください'); return; }
  if(pw !== 'Edic5555'){ alert('パスワードが違います'); return; }
  localStorage.setItem(KEY_ROOM_PREFIX, rid);
  gotoMain();
  });
}


/* ===== メインメニューの遷移（イベント委譲方式） ===== */
document.addEventListener('click', (e)=>{
  const t = e.target.closest('button');
  if (!t) return;

  if (t.id === 'btnGoRun') {
    const saved = localStorage.getItem(KEY_UNLOCK)||'';
    if(!saved){ alert('ロック解除パスワードを設定してください'); return; }
    gotoRun();
  }
  else if (t.id === 'btnGoLayout') {
    gotoLayout();
  }
  else if (t.id === 'btnGoSs') {
    gotoSs();
  }
  else if (t.id === 'btnGoLottery') {
  gotoLottery();
}
}, { passive:true });

/* ===== 履歴CSV ＆ メール下書き ===== */
const btnReport = $('btnMakeReport');
if (btnReport) btnReport.addEventListener('click', generateReport);
function loadHistory(){ try{ return JSON.parse(localStorage.getItem(KEY_HISTORY)||'[]'); }catch{return []} }
function saveHistory(arr){ localStorage.setItem(KEY_HISTORY, JSON.stringify(arr)); }
function generateReport(){
  const el = $('historyDate');
  const pick = el && el.value ? el.value : toDateStr(new Date());
  const hist = loadHistory().filter(r => r.date === pick);

  let lines = ['利用ID,入室時刻,退出時刻'];
  for(const r of hist){
    const inStr  = r.inAt ? toDisp(new Date(r.inAt)) : '';
    const mark = r.outMarked ? '★' : (r.outAuto ? '＊' : '');
const outStr = r.outAt ? `${toDisp(new Date(r.outAt))}${mark}` : '';
    lines.push([r.uid||'', inStr, outStr].join(','));
  }
  const csvBody = lines.join('\r\n');

  // ダウンロード
  const bom = '\uFEFF';
  const blob = new Blob([bom + csvBody], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `${pick.replaceAll('-','')}_利用履歴.csv`;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);

  // メール下書き（mailto）を開く
  const subject = encodeURIComponent(`利用履歴CSV ${pick}`);
const body    = encodeURIComponent(csvBody);
location.href = `mailto:k_hayashi@sozogakuen.co.jp?subject=${subject}&body=${body}`;
}
// 指定日の 23:59:00（ローカル）を返す
function endOfDayLocal(d0){
  const d = new Date(d0);
  d.setHours(23,59,0,0);
  return d;
}

// 日付を跨いだ入室中のIDを「在室していた日」の 23:59:00 で自動退室（＊）にする
function autoCloseOvernights(){
  const todayStr = toDateStr(new Date()); // 'YYYY-MM-DD'
  let changed = false;

  for (const [no, e] of Object.entries(seatState)){
    if (!e || !e.busy) continue;
    const uid = e.uid ? String(e.uid) : '';
    if (!uid) continue;

    const inAt = e.inAt ? new Date(e.inAt) : null;
    if (!inAt) continue;

    const inDayStr = toDateStr(inAt);
    // 在室日 < 本日 なら、その在室日の 23:59:00 で締める
    if (inDayStr < todayStr){
      const leaveAt = endOfDayLocal(inAt);
      // 履歴：＊
      addHistoryOnAutoLeave(uid, leaveAt);
      // ログ送信：＊（payload.star に '＊' を渡す）
      pushLog({
        uid,
        action: 'leave',
        seatNo: String(no),
        method: 'auto',
        roomPrefix: uid.slice(0,3),
        star: '＊'
      });
      // 状態オフ
      seatState[no] = false;
      changed = true;
    }
  }
  if (changed) saveSeatState();
}
/* ロック解除PW保存（メイン） */
const unlockInput=$('unlockPwMain');
unlockInput.value = localStorage.getItem(KEY_UNLOCK)||'';
unlockInput.addEventListener('input',()=>localStorage.setItem(KEY_UNLOCK,(unlockInput.value||'').trim()));

/* ===== ④ レイアウトエディタ ===== */
const editor = { grid: null, cellsEl: $('cells'), nameEl: $('roomName') };

/* --- 座席番号プロンプトの二重起動ガード --- */
let __seatPromptOpen = false;        // ダイアログ表示中フラグ
let __seatPromptBlockUntil = 0;      // 再描画直後の再起動を抑制するための時刻(ms)
function makeAll(t){ return Array.from({length:SIZE},()=>Array.from({length:SIZE},()=>({t,n:null}))); }
function clsEdit(t){ return t===0?'st-wall':t===1?'st-hall':t===2?'st-seat':'st-door'; }
function loadLayout(){ try{const raw=localStorage.getItem(KEY_LAYOUT);return raw?JSON.parse(raw):null;}catch{return null} }
function saveLayout(obj){ localStorage.setItem(KEY_LAYOUT, JSON.stringify(obj)); }

function renderEditor(){
  editor.grid = loadLayout() || makeAll(0);
  editor.nameEl.value = localStorage.getItem(KEY_NAME)||'';
  editor.cellsEl.innerHTML='';
  for(let y=0;y<SIZE;y++){
    for(let x=0;x<SIZE;x++){
      const st=editor.grid[y][x]; const d=document.createElement('div');
      d.className='cell '+clsEdit(st.t); d.dataset.x=x; d.dataset.y=y;
      if(st.t===2 && st.n){
        const s=document.createElement('span'); s.textContent=st.n; d.appendChild(s);
      }
      if(st.t===3){
        const l=document.createElement('div'); l.className='label'; l.textContent='入口'; d.appendChild(l);
      }
      // 左クリック：壁→廊下→入口→壁
            // ===== タップ/クリックを Pointer Events に統一 =====
      const toggleCell = ()=>{
        const cur = editor.grid[y][x]; let next;
        if(cur.t===0) next=1; else if(cur.t===1) next=3; else next=0;
        editor.grid[y][x]={t:next,n:null}; saveLayout(editor.grid); renderEditor();
      };
      const seatPrompt = ()=>{
        if (__seatPromptOpen) return;
        __seatPromptOpen = true;
        const v = prompt('座席番号を入力（空で取消）', st.t===2 ? (st.n||'') : '');
        if (v != null && v.trim() !== '') {
          editor.grid[y][x] = { t: 2, n: v.trim() };
          saveLayout(editor.grid);
        }
        __seatPromptOpen = false;
        __seatPromptBlockUntil = Date.now() + 800;
        renderEditor();
      };

      let pressTid=null, downAt=0, startX=0, startY=0, moved=false;
      const LONG_MS=450, MOVE_PX=8;

      const onPointerDown = (e)=>{
        if(e.button===2){ seatPrompt(); return; }
        moved=false;
        downAt=Date.now(); startX=e.clientX; startY=e.clientY;
        clearTimeout(pressTid);
        pressTid=setTimeout(()=>{ pressTid=null; seatPrompt(); }, LONG_MS);
      };
      const onPointerMove = (e)=>{
        if(!pressTid) return;
        const dx=e.clientX-startX, dy=e.clientY-startY;
        if(Math.hypot(dx,dy)>MOVE_PX){ moved=true; clearTimeout(pressTid); pressTid=null; }
      };
      const onPointerUp = ()=>{
        if(pressTid){ clearTimeout(pressTid); pressTid=null; if(!moved) toggleCell(); }
      };
      const onPointerCancel = ()=>{ clearTimeout(pressTid); pressTid=null; };

      d.addEventListener('contextmenu', e=>{ e.preventDefault(); seatPrompt(); });
      d.addEventListener('pointerdown', onPointerDown);
      d.addEventListener('pointermove', onPointerMove);
      d.addEventListener('pointerup', onPointerUp);
      d.addEventListener('pointercancel', onPointerCancel);

      editor.cellsEl.appendChild(d);
    }
  }
}
editor.nameEl && editor.nameEl.addEventListener('input', ()=> localStorage.setItem(KEY_NAME, editor.nameEl.value.trim()));
$('allWall').addEventListener('click', ()=>{ if(confirm('全て壁にしますか？')){ editor.grid=makeAll(0); saveLayout(editor.grid); renderEditor(); }});
$('allHall').addEventListener('click', ()=>{ if(confirm('全て廊下にしますか？')){ editor.grid=makeAll(1); saveLayout(editor.grid); renderEditor(); }});
$('saveBtn').addEventListener('click', ()=>{
  const data = { version:1, name:(localStorage.getItem(KEY_NAME)||'').trim(), size:{w:SIZE,h:SIZE}, cells:editor.grid };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const a=document.createElement('a'); const base = (editor.nameEl.value||data.name||'layout').trim();
  const now=new Date();
  const ts = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}-${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`;
  a.download = `${base}_${ts}.json`; a.href=URL.createObjectURL(blob); a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href),0);
});
$('openBtn').addEventListener('click', ()=> $('fileOpen').click());
$('fileOpen').addEventListener('change', async (e)=>{
  const f=e.target.files && e.target.files[0]; if(!f) return;
  try{
    const obj=JSON.parse(await f.text());
    if(!obj || !obj.size || !obj.cells) throw new Error('形式が不正');
    if(obj.size.w!==SIZE || obj.size.h!==SIZE) throw new Error('サイズ不一致');
    editor.grid = obj.cells; saveLayout(editor.grid);
    const nm=(obj.name||'').trim(); localStorage.setItem(KEY_NAME, nm); editor.nameEl.value = nm;
    renderEditor(); alert('インポートしました');
  }catch(err){ alert('インポート失敗: '+err.message); }
  e.target.value='';
});

/* ===== ⑤ 運用表示 ===== */
const seatState = JSON.parse(localStorage.getItem('seatState')||'{}');
function saveSeatState(){ localStorage.setItem('seatState', JSON.stringify(seatState)); }
function loadName(){ return (localStorage.getItem(KEY_NAME)||'').trim() || '自習室'; }
function computeCroppedArea(g){
  let minX=SIZE, minY=SIZE, maxX=-1, maxY=-1;
  for(let y=0;y<SIZE;y++){
    for(let x=0;x<SIZE;x++){
      const t = g?.[y]?.[x]?.t;
      if (t===1 || t===2 || t===3){
        if(x<minX) minX=x;
        if(x>maxX) maxX=x;
        if(y<minY) minY=y;
        if(y>maxY) maxY=y;
      }
    }
  }
  if (maxX<0) return { minX:0, minY:0, maxX:SIZE-1, maxY:SIZE-1 };
  // ← マージン（±1）を外して、そのままの範囲だけを返す
  return { minX, minY, maxX, maxY };
}
function isBusyEntry(e){ return !!(e && (e===true || e.busy)); }
function clsRun(t, seatNo){ if(t===0)return'live-wall'; if(t===1)return'live-hall'; if(t===3)return'live-door'; const busy = isBusyEntry(seatState[seatNo]); return busy?'live-seat-busy':'live-seat-empty'; }

const liveWrap=$('liveWrap'), liveGrid=$('liveGrid'), runRoomTitle=$('runRoomTitle');
function fitCellSize(cols, rows){
  const pad=24; const w=liveWrap.clientWidth-pad; const h=liveWrap.clientHeight-pad;
  const gap=4; const cellW=Math.floor((w-gap*(cols-1))/cols); const cellH=Math.floor((h-gap*(rows-1))/rows);
  const size=Math.max(10, Math.min(cellW,cellH)); liveGrid.style.setProperty('--cell', size+'px');
}
function renderRun(){
  runRoomTitle.textContent=loadName();
  const g=loadLayout();
  if(!g){ liveGrid.innerHTML='<div style="opacity:.7">レイアウトが見つかりません（レイアウト作成で保存してください）</div>'; return; }
  const {minX,minY,maxX,maxY}=computeCroppedArea(g);
  const cols=maxX-minX+1, rows=maxY-minY+1;
  liveGrid.style.gridTemplateColumns = `repeat(${cols}, var(--cell))`;
liveGrid.style.gridTemplateRows = `repeat(${rows}, var(--cell))`;
  liveGrid.innerHTML='';
  for(let y=minY;y<=maxY;y++){
    for(let x=minX;x<=maxX;x++){
      const st=g[y][x]||{t:0};
      const seatNo=(st.t===2&&st.n)?String(st.n):null;
      const cell=document.createElement('div');
      cell.className='live-cell '+clsRun(st.t, seatNo);
      if(st.t===2 && seatNo){
        const tag=document.createElement('div'); tag.className='seatno'; tag.textContent=seatNo; cell.appendChild(tag);
        cell.addEventListener('click', ()=> openSeatOps(seatNo));
      }
      if(st.t===3){
        const lab=document.createElement('div'); lab.className='doorTag'; lab.textContent='入口'; cell.appendChild(lab);
      }
      liveGrid.appendChild(cell);
    }
  }
  fitCellSize(cols, rows);
}
window.addEventListener('resize', ()=>{
  if($('view-run').classList.contains('hidden')) return;
  forceRunFit();
});

/* 時計 */
const dateEl=$('dateText'), timeEl=$('timeText');
function updateClock(){
  const d=new Date(), wk=['日','月','火','水','木','金','土'][d.getDay()];
  dateEl.textContent = `${d.getFullYear()}/${fmt2(d.getMonth()+1)}/${fmt2(d.getDate())}（${wk})`;
  timeEl.textContent = `${fmt2(d.getHours())}:${fmt2(d.getMinutes())}`;
}
updateClock(); setInterval(updateClock, 30000);

/* ⑤→③ 戻る時はロック解除PW */
function backToMainFromRun(){
  const saved = localStorage.getItem(KEY_UNLOCK)||'';
  if(!saved){
    alert('メインメニューに戻るには、先にメインメニューでロック解除パスワードを設定してください。');
    return;
  }
  const input = prompt('ロック解除パスワードを入力してください');
  if(input===saved){
    gotoMain();
  }else{
    alert('パスワードが一致しません。メインメニューには戻れません。');
  }
}

/* 座席操作ダイアログ */
const dlgSeatOps=$('dlgSeatOps'), moveToSeat=$('moveToSeat'), unlockPwOps=$('unlockPwOps'),
      opsWarn=$('opsWarn'), opsCancel=$('opsCancel'), opsOk=$('opsOk'), btnDoLeave=$('btnDoLeave'),
      seatOpsUsage=$('seatOpsUsage');
let seatOpsTarget=null;
function checkUnlock(pw){ const saved=localStorage.getItem(KEY_UNLOCK)||''; return saved && saved===String(pw); }
function openSeatOps(seatNo){
  seatOpsTarget=seatNo; moveToSeat.value=''; unlockPwOps.value=''; opsWarn.style.display='none';
  const entry = seatState[seatNo];
  if (isBusyEntry(entry)) {
    const uid = (entry && entry.uid) ? entry.uid : '不明';
    seatOpsUsage.textContent = `使用中（${uid})`;
  } else {
    seatOpsUsage.textContent = '';
  }
  dlgSeatOps.style.display='flex';
}
function closeSeatOps(){ dlgSeatOps.style.display='none'; seatOpsTarget=null; }
opsCancel.addEventListener('click', closeSeatOps);
opsOk.addEventListener('click', ()=>{
  opsWarn.style.display='none';
  if(!checkUnlock(unlockPwOps.value)){ opsWarn.style.display='block'; return; }

  const to = (moveToSeat.value||'').trim();
  const from = seatOpsTarget ? String(seatOpsTarget) : '';
  if (from && to){
    const prev = seatState[from];
    const uid = (prev && prev.uid) ? String(prev.uid) : '';

    // 状態更新
    seatState[from] = false;
    seatState[to] = uid
      ? { busy:true, uid, inAt: prev?.inAt || undefined }
      : true;
    saveSeatState();

    // ★ ログ（列は既存のまま）
    //   action: "move"
    //   seatNo: "from->to" （例: "12->27"）
    //   uid   : 可能なら利用ID、なければ空文字
    //   method: "admin"（座席操作ダイアログ由来）
    //   roomPrefix: uid 先頭3文字（空なら空）
    pushLog({
      uid,
      action: 'move',
      seatNo: `${from}>${to}`,
      method: 'admin',
      roomPrefix: uid ? String(uid).slice(0,3) : '',
      star: false
    });
  }

  closeSeatOps();
  renderRun();
  setTimeout(forceRunFit, 16);
});
btnDoLeave.addEventListener('click', ()=>{
  opsWarn.style.display='none';
  if(!checkUnlock(unlockPwOps.value)){ opsWarn.style.display='block'; return; }
  if(seatOpsTarget){
    const prev = seatState[seatOpsTarget];
    const uid = prev && prev.uid ? prev.uid : null;
    if (uid) {
      addHistoryOnLeave(uid, new Date(), true);
      pushLog({ uid, action:'leave', seatNo: seatOpsTarget, method:'admin', roomPrefix: String(uid).slice(0,3), star:true });
    }
    seatState[seatOpsTarget]=false; saveSeatState();
  }
  closeSeatOps(); renderRun(); setTimeout(forceRunFit, 16);
});

/* ===== ⑥ スキャン（入室/退出） ===== */
let scanMode='enter'; // 'enter' or 'leave'
let lastScannedValue = '';
let lastInputMethod = 'qr'; // 'qr' | 'input'
const video=$('video'), statusEl=$('status'), resultEl=$('result'), errEl=$('err'),
      restartBtn=$('restart'), switchBtn=$('switchCam'), idInput=$('idInput'), okBtn=$('okBtn'), okNote=$('okNote'),
      overlay=$('overlay'), guide=$('guide');
let stream=null, scanning=false, useEnvironment=false, rafId=null;
const canvas=document.createElement('canvas'), ctx=canvas.getContext('2d',{willReadFrequently:true});
const GUIDE_SCALE=0.7;
function openScan(mode){ scanMode = (mode==='leave') ? 'leave' : 'enter'; startScanView(); }
function backFromScan(){ stopCamera(); gotoRun(); }
function fitOverlayToVideo(){
  const vw=video.clientWidth, vh=video.clientHeight, offLeft=video.offsetLeft, offTop=video.offsetTop;
  if(vw===0||vh===0) return;
  overlay.style.position='absolute';
  overlay.style.left=offLeft+'px'; overlay.style.top=offTop+'px';
  overlay.style.width=vw+'px'; overlay.style.height=vh+'px';
  const side=Math.floor(Math.min(vw,vh)*GUIDE_SCALE);
  guide.style.width=side+'px'; guide.style.height=side+'px';
  guide.style.position='absolute';
  guide.style.left=Math.floor((vw-side)/2)+'px'; guide.style.top=Math.floor((vh-side)/2)+'px';
}
async function startCamera(){
  stopCamera(); errEl.textContent=''; resultEl.style.display='none';
  statusEl.textContent='カメラを起動しています…'; restartBtn.classList.add('hidden');
  try{
    stream = await navigator.mediaDevices.getUserMedia({
      audio:false, video:{ facingMode: useEnvironment?{ideal:'environment'}:{ideal:'user'}, width:{ideal:1280}, height:{ideal:720} }
    });
    video.srcObject=stream; await video.play();
    try{
      const cams=(await navigator.mediaDevices.enumerateDevices()).filter(d=>d.kind==='videoinput');
      switchBtn.classList.toggle('hidden', !(cams.length>1));
    }catch{}
    scanning=true; statusEl.textContent='QRコードを水色枠の中央に合わせてください…';
    fitOverlayToVideo(); scanLoop();
  }catch(e){
    console.error(e); errEl.textContent='カメラを起動できません。ブラウザの許可とHTTPSを確認してください。';
    restartBtn.classList.remove('hidden'); statusEl.textContent='起動待機中';
  }
}
function stopCamera(){ scanning=false; if(rafId){cancelAnimationFrame(rafId);rafId=null;} if(stream){stream.getTracks().forEach(t=>t.stop()); stream=null;} }
function scanLoop(){
  if(!scanning) return;
  if(video.readyState===video.HAVE_ENOUGH_DATA){
    const vw=video.videoWidth, vh=video.videoHeight, scale=vw>1280?0.5:1.0;
    canvas.width=Math.floor(vw*scale); canvas.height=Math.floor(vh*scale);
    ctx.drawImage(video,0,0,canvas.width,canvas.height);
    const img=ctx.getImageData(0,0,canvas.width,canvas.height);
    const code=jsQR(img.data,img.width,img.height,{inversionAttempts:'dontInvert'});
    if(code&&code.data){ lastInputMethod='qr'; onDetected(code.data); return; }
  }
  rafId=requestAnimationFrame(scanLoop);
}
function onDetected(text){
  scanning=false; statusEl.textContent='QRを読み取りました。'; stopCamera();
  resultEl.textContent=text; resultEl.style.display='block'; restartBtn.classList.remove('hidden');
  if(navigator.vibrate) navigator.vibrate(60);
  openConfirmWithValue(text);
}
restartBtn.addEventListener('click', ()=>{ resultEl.style.display='none'; startCamera(); });
switchBtn.addEventListener('click', ()=>{ useEnvironment=!useEnvironment; startCamera(); });
okBtn.addEventListener('click', ()=>{
  const v=(idInput.value||'').trim();
  if(!v){ okNote.style.display='block'; okNote.textContent='利用IDを入力してください。'; return; }
  okNote.style.display='none'; stopCamera(); lastInputMethod='input'; openConfirmWithValue(v);
});

/* 確認モーダル：OK/キャンセル */
const confirmDlg=$('confirmDlg'), confirmMsgEl=$('confirmMsg'),
      confirmCancelBtn=$('confirmCancel'), confirmOkBtn=$('confirmOk');
if (confirmCancelBtn) confirmCancelBtn.addEventListener('click', ()=>{ if (confirmDlg) confirmDlg.style.display='none'; gotoRun(); });
if (confirmOkBtn) confirmOkBtn.addEventListener('click', ()=>{
  confirmDlg.style.display='none';
  if (scanMode==='enter') {
    const seatNo = findRecommendedSeat();
    if (!seatNo) { alert('割り当て可能な座席が見つかりません。'); gotoRun(); return; }
    openAssignWithSeat(seatNo);
  } else {
    const uid = lastScannedValue;
    const seatNo = findSeatByUid(uid);
    if (!seatNo) {
      openInfo('このIDは利用中ではありません');
      return;
    } else {
      addHistoryOnLeave(uid, new Date(), false);
      pushLog({ uid, action:'leave', seatNo, method:lastInputMethod, roomPrefix: String(uid).slice(0,3), star:false });
      seatState[seatNo] = false;
      saveSeatState();
      gotoRun();
    }
  }
});
function openConfirmWithValue(v){
  // 1) 教室ID先頭3桁チェック
  const rp = (localStorage.getItem(KEY_ROOM_PREFIX)||'').slice(0,3);
  const head3 = String(v).slice(0,3);
  if(!rp || head3 !== rp){ openInfo('このIDは承認されていません'); return; }

  // 2) 利用中重複（入室時）
  if (scanMode==='enter') {
    if (findSeatByUid(v)) { openInfo('このIDは現在利用中です'); return; }
  }

  lastScannedValue = v;
  confirmMsgEl.textContent =
  (scanMode==='enter')
    ? `${v}　利用を開始しますか？`
    : `${v}　利用を終了しますか？`;
  confirmDlg.style.display='flex';
}

/* 座席割当モーダル（入室OK後） */
const assignDlg = $('assignDlg');
const assignMsg = $('assignMsg');
$('assignCancel').addEventListener('click', ()=>{ assignDlg.style.display='none'; gotoRun(); });
$('assignOk').addEventListener('click', ()=>{
  const m = assignMsg.textContent.match(/No\.([^の]+)\s*の座席/);
  if (m) {
    const no = String(m[1]).trim();
    const now = new Date();
    seatState[no] = lastScannedValue ? {busy:true, uid:lastScannedValue, inAt: now.toISOString()} : {busy:true, inAt: now.toISOString()};
    saveSeatState();
    addHistoryOnEnter(lastScannedValue||'', now);
    pushLog({ uid:lastScannedValue||'', action:'enter', seatNo:no, method:lastInputMethod, roomPrefix: String(lastScannedValue||'').slice(0,3) });
  }
  assignDlg.style.display='none';
  gotoRun();
});
function openAssignWithSeat(seatNo){
  assignMsg.textContent = `No.${seatNo} の座席を利用してください。`;
  assignDlg.style.display='flex';
}

/* 退室時用：情報モーダル */
const infoDlg = $('infoDlg');
const infoMsg = $('infoMsg');
$('infoOk').addEventListener('click', ()=>{ infoDlg.style.display='none'; });
function openInfo(msg){
  infoMsg.textContent = msg || '情報';
  infoDlg.style.display = 'flex';
}

/* 座席推薦ロジック */
function findRecommendedSeat(){
  const grid = loadLayout();
  if (!grid) return null;

  const seats = [], doors = [];
  for (let y=0; y<SIZE; y++){
    for (let x=0; x<SIZE; x++){
      const st = grid[y][x];
      if (!st) continue;
      if (st.t === 2 && st.n){
        seats.push({ no: String(st.n), x, y });
      } else if (st.t === 3){
        doors.push({ x, y });
      }
    }
  }
  if (seats.length === 0) return null;

  const busyCoords = seats.filter(s => isBusyEntry(seatState[s.no])).map(s => ({x:s.x, y:s.y}));
  const dist = (a,b)=> Math.hypot(a.x-b.x, a.y-b.y);

  let bestSeat = null, bestScore = -Infinity;
  for (const s of seats){
    if (isBusyEntry(seatState[s.no])) continue;

    let score;
    if (busyCoords.length > 0){
      let minD = Infinity;
      for (const b of busyCoords){ const d = dist(s, b); if (d < minD) minD = d; }
      score = minD;
    } else if (doors.length > 0){
      let minD = Infinity;
      for (const d0 of doors){ const d = dist(s, d0); if (d < minD) minD = d; }
      score = minD;
    } else {
      const center = { x:(SIZE-1)/2, y:(SIZE-1)/2 };
      score = dist(s, center);
    }

    if (score > bestScore || (score === bestScore && bestSeat && (s.y < bestSeat.y || (s.y===bestSeat.y && s.x < bestSeat.x)))){
      bestScore = score; bestSeat = s;
    }
  }
  return bestSeat ? bestSeat.no : null;
}

/* 利用ID → 着席中の座席No 検索 */
function findSeatByUid(uid){
  if (!uid) return null;
  for (const [no, entry] of Object.entries(seatState)){
    if (entry && entry.busy && String(entry.uid) === String(uid)) {
      return no;
    }
  }
  return null;
}

/* === 利用履歴 === */
// outMarked: 手動/管理者の特別退室（★）
// outAuto  : 日跨ぎの自動退室（＊）
function addHistoryOnEnter(uid, when){
  const arr = loadHistory();
  arr.push({
    date: toDateStr(when),
    uid: String(uid||''),
    inAt: when.toISOString(),
    outAt: null,
    outMarked: false,
    outAuto: false,
  });
  saveHistory(arr);
}
function addHistoryOnLeave(uid, when, withStar){
  const arr = loadHistory();
  for (let i = arr.length - 1; i >= 0; i--){
    const r = arr[i];
    if (String(r.uid) === String(uid) && !r.outAt){
      r.outAt = when.toISOString();
      r.outMarked = !!withStar;
      // 自動ではない通常/管理者退室なので outAuto は false のまま
      r.outAuto = r.outAuto || false;
      break;
    }
  }
  saveHistory(arr);
}
// 自動退室（＊）専用：指定 uid の未退室レコードを 23:59:00 で締める
function addHistoryOnAutoLeave(uid, leaveAt){
  const arr = loadHistory();
  for (let i = arr.length - 1; i >= 0; i--){
    const r = arr[i];
    if (String(r.uid) === String(uid) && !r.outAt){
      r.outAt = leaveAt.toISOString();
      r.outMarked = false;   // ★は付けない
      r.outAuto = true;      // ＊を付ける
      break;
    }
  }
  saveHistory(arr);
}

/* ===== スキャン画面イベント ===== */
window.addEventListener('resize', ()=>{ if(!$('view-scan').classList.contains('hidden')) fitOverlayToVideo(); });
window.addEventListener('orientationchange', ()=>{ if(!$('view-scan').classList.contains('hidden')) fitOverlayToVideo(); });
video.addEventListener('loadedmetadata', fitOverlayToVideo);
video.addEventListener('playing', fitOverlayToVideo);

/* スキャン画面初期化 */
function startScanView(){
  $('scanTitle').textContent = (scanMode==='enter'?'入室スキャン':'退室スキャン');
  show('view-scan');
  $('idInput').value = '';
  startCamera();
}

/* ====== 集約ログ送信（GAS） ====== */
const LOG_HUB_URL = 'https://script.google.com/macros/s/AKfycby4vRo8lGnNtfnl8_4juv8TUqdxCnTWZH6_t280olFsjsakclCScGtJrsw1wb31gaus/exec';
const LOG_SHARED_KEY = '';
const DEVICE_ID_KEY = 'device-id';
function getDeviceId(){
  let id = localStorage.getItem(DEVICE_ID_KEY);
  if (!id) { id = 'dev-' + Math.random().toString(36).slice(2) + Date.now(); localStorage.setItem(DEVICE_ID_KEY, id); }
  return id;
}
const LOG_QUEUE_KEY = 'usage-log-queue';
function loadQueue(){ try{ return JSON.parse(localStorage.getItem(LOG_QUEUE_KEY)||'[]'); }catch{return[]} }
function saveQueue(q){ localStorage.setItem(LOG_QUEUE_KEY, JSON.stringify(q)); }
async function pushLog(payload){
  const now = new Date();
  // payload.star は true/false だけでなく '＊' も許容（true=★, '＊'=＊, それ以外は空）
  const starStr = (payload.star === '＊') ? '＊' : (payload.star ? '★' : '');
  const body = new URLSearchParams({
    apikey: LOG_SHARED_KEY || '',
    uid: String(payload.uid||''),
    action: String(payload.action||''),
    seatNo: payload.seatNo || '',
    method: payload.method || '',
    roomPrefix: payload.roomPrefix || '',
    star: starStr,
    clientTime: now.toISOString(),
    clientTz: Intl.DateTimeFormat().resolvedOptions().timeZone || '',
    deviceId: getDeviceId(),
    ua: navigator.userAgent
  });
  try{
    const res = await fetch(LOG_HUB_URL, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
    const json = await res.json().catch(()=>({}));
    if (json && json.ok) return true;
    throw new Error('server not ok');
  }catch(err){
    const q = loadQueue();
    q.push(Object.fromEntries(body));
    saveQueue(q);
    return false;
  }
}
async function flushLogQueue(){
  let q = loadQueue();
  if (!q.length) return;
  const next = [];
  for (const item of q){
    try{
      const res = await fetch(LOG_HUB_URL, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: new URLSearchParams(item) });
      const json = await res.json().catch(()=>({}));
      if (!(json && json.ok)) next.push(item);
    }catch{ next.push(item); }
  }
  saveQueue(next);
}
window.addEventListener('online', flushLogQueue);
window.addEventListener('focus', flushLogQueue);
document.addEventListener('visibilitychange', ()=>{
  if (document.visibilityState==='visible'){
    flushLogQueue();
    autoCloseOvernights();
  }
});
window.addEventListener('load', ()=>{
  flushLogQueue();
  loadSsSettings();
  resetIdleTimer();
  autoCloseOvernights();                 // 起動直後に取りこぼしを処理
  setInterval(autoCloseOvernights, 60*1000); // 以降は毎分チェック
});

/* ====== スライドショー（全画面・アイドル起動） ====== */
const SS_KEY = 'ss.settings.v1';
const SS_MEDIA_KEY = 'ss.media.v1';
let ssTimer=null, ssIdleMs=600000;

// 追加: iPad は保存せず直接再生するモード
const isIOSLike = /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
// （旧）一時FileList依存をやめ、確定リストに積む
let ssTransientMode = false; // 使わない（将来の互換用に残すだけ）
let confirmedMedia = [];     // ← ここに {type:'image'|'video', url, name} を確定保存
let __currentObjectUrl = null;
let ssEnabledFlag = false;
// 互換のため残す（ローカル保存派生の既存データがあればフォールバックで使う）
let ssFilesArr = []; // {type:'image'|'video', url:objectURL}
// 複数曲対応：選択された曲の配列 [{id,title,url}]
let ssBgmList = [];
let ssAudio = null;
let __bgmIndex = -1; // 直前に再生したインデックス（連続同一回避用）
const ssOverlay = $('ssOverlay'), ssLayerA=$('ssLayerA'), ssLayerB=$('ssLayerB');
let ssIndex=0, ssShowingA=true, ssRunning=false;
let ssOrder = [];      // 再生順インデックス配列（ランダム）
let ssFirstFrame = true; // 初回フレームは画像ロード完了を待ってからフェード
let ssNextTid = null;  // 次コマ予約タイマー（停止/再実行時に確実にクリア）

// 追加：現在選択されているメディア数を返す（iPad一時再生対応）
function mediaCount(){
  if (Array.isArray(confirmedMedia) && confirmedMedia.length>0) return confirmedMedia.length;
  return ssFilesArr.length; // 互換：旧ローカル保存配列があれば使う
}

function buildRandomOrder(len){
  const arr = Array.from({length: len}, (_,i)=>i);
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]] = [arr[j],arr[i]];
  }
  return arr;
}

function loadSsSettings(){
  try{
    const s = JSON.parse(localStorage.getItem(SS_KEY)||'{}');
    ssEnabledFlag = !!s.enabled;
    ssIdleMs = Math.max(1000, (s.idleMin||10)*60000);
    window.__ssDurationSec = Math.max(3, s.durationSec||10);
    ssBgmList = Array.isArray(s.bgmList) ? s.bgmList : [];
    const media = JSON.parse(localStorage.getItem(SS_MEDIA_KEY)||'[]');
    ssFilesArr = media;
  }catch{
    ssEnabledFlag=false; ssIdleMs=600000; window.__ssDurationSec=10; ssFilesArr=[]; ssBgmUrl=''; ssBgmTitle='';
  }
}
function saveSsSettingsUI(){
  // 入力値を即時にグローバルへ反映し、テスト開始直後のズレを解消
  const dur = Math.max(3, Number($('ssDuration').value || 10)); // 入力min=3と整合
  const s = {
    enabled: $('ssEnabled').checked,
    idleMin: Number($('ssIdleMin').value || 10),
    durationSec: dur,
    bgmList: Array.isArray(ssBgmList) ? ssBgmList : [],
  };
  localStorage.setItem(SS_KEY, JSON.stringify(s));
  window.__ssDurationSec = dur; // ← ここがポイント：すぐに startSlideShow が新秒数を使う
  // 追加：グローバルの即時反映
  ssEnabledFlag = s.enabled;
  ssIdleMs = Math.max(1000, s.idleMin * 60000);
  updateBgmNow();
}
function loadSsSettingsUI(){
  loadSsSettings();
  $('ssEnabled').checked = ssEnabledFlag;
  $('ssIdleMin').value = Math.round(ssIdleMs/60000);
  $('ssDuration').value = window.__ssDurationSec;
  updateBgmNow();
}
function updateBgmNow(){
  const el=$('bgmNow');
  if (!ssBgmList || ssBgmList.length===0) {
    el.textContent = '（未選択）';
  } else if (ssBgmList.length===1) {
    el.textContent = ssBgmList[0].title || '(タイトルなし)';
  } else {
    el.textContent = `${ssBgmList.length}曲選択中`;
  }
}
$('btnSsBack').addEventListener('click', gotoMain);
$('btnSsSave').addEventListener('click', ()=>{
  saveSsSettingsUI();
  alert('保存しました');
  resetIdleTimer();
});
$('btnSsTest').addEventListener('click', ()=>{
  saveSsSettingsUI(); // ↑で ssEnabledFlag / ssIdleMs も即時反映
  if (mediaCount() === 0){
    alert('写真・動画が選択されていません');
    return;
  }
  startSlideShow(true); // 強制起動
});

/* メディア選択 */

// サムネイル置き場を動的に生やす（最初の「写真・動画」カード内の下に足す）
function ensureThumbsContainer(){
  let host = document.querySelector('#view-ss .card .file-row');
  if(!host) return null;
  let box = document.getElementById('ssThumbs');
  if(!box){
    box = document.createElement('div');
    box.id = 'ssThumbs';
    box.style.cssText = 'display:flex;gap:8px;flex-wrap:wrap;margin-top:8px';
    host.appendChild(box);
  }
  return box;
}
function renderThumbs(){
  const box = ensureThumbsContainer();
  if(!box) return;
  box.innerHTML = '';
  if(!confirmedMedia || confirmedMedia.length===0){
    const p = document.createElement('div');
    p.style.color = '#9aa0a6';
    p.textContent = '（選択済みのメディアはありません）';
    box.appendChild(p);
    return;
  }
  confirmedMedia.forEach((m, idx)=>{
    const w = document.createElement('div');
    w.style.cssText='position:relative;width:90px;height:60px;border:1px solid #333;border-radius:6px;overflow:hidden;background:#000';
    const del = document.createElement('button');
    del.textContent = '×';
    del.title = 'このメディアを削除';
    del.style.cssText='position:absolute;right:2px;top:2px;font-size:12px;border:1px solid #444;background:#111;color:#fff;border-radius:4px;cursor:pointer;padding:0 4px;line-height:1.6';
    del.addEventListener('click', ()=>{
      // URL解放
      if (m.url && m.url.startsWith('blob:')) { try{ URL.revokeObjectURL(m.url);}catch{} }
      confirmedMedia.splice(idx,1);
      renderThumbs();
      resetIdleTimer();
    });
    w.appendChild(del);

    if(m.type==='image'){
      const img = document.createElement('img');
      img.src = m.url;
      img.style.cssText='width:100%;height:100%;object-fit:cover;display:block';
      w.appendChild(img);
    }else{
      const ic = document.createElement('div');
      ic.textContent = 'VIDEO';
      ic.style.cssText='color:#bbb;font-size:12px;position:absolute;left:6px;bottom:4px;background:rgba(0,0,0,.5);padding:2px 4px;border-radius:4px';
      const v = document.createElement('video');
      v.src = m.url; v.muted = true; v.playsInline = true;
      v.style.cssText='width:100%;height:100%;object-fit:cover;display:block;opacity:.9';
      w.appendChild(v); w.appendChild(ic);
    }
    box.appendChild(w);
  });
}

// ファイルが選ばれたら「確定リスト」に追加していく（inputの状態には依存しない）
$('ssFiles').addEventListener('change', async (e)=>{
  const files = Array.from(e.target.files || []).filter(f => f && f.size>0);
  if(files.length===0) return;

  // 既存の「実行中URL」を解放してリセット
  try{
    if(__currentObjectUrl && __currentObjectUrl.startsWith('blob:')) URL.revokeObjectURL(__currentObjectUrl);
  }catch{}
  __currentObjectUrl = null;

  // 追加
  for(const f of files){
    const lower = (f.name||'').toLowerCase();
    const isImg = (f.type||'').startsWith('image/') || /\.(jpe?g|png|gif|webp|bmp|heic|heif|avif)$/.test(lower);
    const url = URL.createObjectURL(f);
    confirmedMedia.push({ type: isImg ? 'image' : 'video', url, name: f.name||'' });
  }
  // input は毎回リセット（次の選択で追加できるように）
  e.target.value = '';

  renderThumbs();
  resetIdleTimer();
});

// すべての選択を解除（確定リストと旧保存分の両方に対応）
$('clearMedia').addEventListener('click', ()=>{
  stopSlideShow();

  // 再生中URLを解放
  try{
    if(__currentObjectUrl && __currentObjectUrl.startsWith('blob:')) URL.revokeObjectURL(__currentObjectUrl);
  }catch{}
  __currentObjectUrl = null;

  // confirmedMedia のURL解放
  try{
    (Array.isArray(confirmedMedia)?confirmedMedia:[]).forEach(m=>{
      if(m && typeof m.url==='string' && m.url.startsWith('blob:')){ try{ URL.revokeObjectURL(m.url);}catch{} }
    });
  }catch{}

  // 旧保存配列（互換）のURL解放
  try{
    (Array.isArray(ssFilesArr)?ssFilesArr:[]).forEach(it=>{
      if(it && typeof it.url==='string' && it.url.startsWith('blob:')){ try{ URL.revokeObjectURL(it.url);}catch{} }
    });
    const prev = JSON.parse(localStorage.getItem(SS_MEDIA_KEY)||'[]');
    (Array.isArray(prev)?prev:[]).forEach(it=>{
      if(it && typeof it.url==='string' && it.url.startsWith('blob:')){ try{ URL.revokeObjectURL(it.url);}catch{} }
    });
  }catch{}

  // データ消去
  confirmedMedia = [];
  ssFilesArr = [];
  try{ localStorage.removeItem(SS_MEDIA_KEY); }catch{}
  const fi = $('ssFiles'); if (fi) fi.value='';

  renderThumbs();
  if (typeof resetIdleTimer === 'function') resetIdleTimer();

  alert('選択を解除しました（確定リストと保存データを削除／URLも解放済み）');
});

// 初期表示時にサムネイル置き場だけ用意
ensureThumbsContainer();
renderThumbs();

/* BGM 選択 */
$('btnPickBgm').addEventListener('click', openBgmPicker);
$('clearBgm').addEventListener('click', ()=>{
  ssBgmList = [];
  saveSsSettingsUI();
  updateBgmNow();
});

/* 画像ダウンスケール */
async function downscaleImageFile(file){
  const bitmap = await createImageBitmap(file);
  const maxW = window.innerWidth;
  const maxH = window.innerHeight;
  const scale = Math.min(1, Math.min(maxW / bitmap.width, maxH / bitmap.height));
  const w = Math.round(bitmap.width * scale);
  const h = Math.round(bitmap.height * scale);
  const c = new OffscreenCanvas(w, h);
  const ctx = c.getContext('2d', { alpha:false });
  ctx.drawImage(bitmap, 0, 0, w, h);
  const blob = await c.convertToBlob({ type:'image/jpeg', quality:0.85 });
  return URL.createObjectURL(blob);
}

/* アイドル監視（ユーザー操作でBGMを“解錠”しておく） */
const __gestureEvents = ['pointerdown','touchstart','mousedown','keydown','mousemove'];
__gestureEvents.forEach(ev=>{
  window.addEventListener(ev, (e)=>{
    primeBgmFromGesture();     // ← iOS向け：ここで一度だけ無音再生して解錠
    resetIdleTimer();
  }, {passive:true});
});

function resetIdleTimer(){
  if (ssTimer) clearTimeout(ssTimer);
  loadSsSettings();
  if (!ssEnabledFlag || mediaCount()===0){ stopSlideShow(); return; }
  ssTimer = setTimeout(startSlideShow, ssIdleMs);
}

/* iOS対策：ユーザー操作中にBGMを一度だけ無音再生→停止して“解錠” */
function primeBgmFromGesture(){
  try{
    if(!ssBgmList || ssBgmList.length===0) return;
    if(!ssAudio){
      ssAudio = new Audio();
      ssAudio.crossOrigin = 'anonymous';
      ssAudio.loop = true;
    }
    if (ssAudio.__primed) return;

    ssAudio.muted = true;
    if (!ssAudio.src) ssAudio.src = ssBgmList[0].url; // 適当に先頭曲を使って“解錠”
    ssAudio.play().then(()=>{
      // すぐ停止＆元に戻す（“再生可能な状態”だけ獲得）
      ssAudio.pause();
      ssAudio.currentTime = 0;
      ssAudio.muted = false;
      ssAudio.__primed = true;
    }).catch(()=>{ /* 失敗しても次の操作でまた試す */ });
  }catch{}
}
function startSlideShow(force=false){
  if (!force && (!ssEnabledFlag || mediaCount()===0)) return;

  // 残タスクを完全クリア
  if (ssNextTid){ clearTimeout(ssNextTid); ssNextTid = null; }
  try{
    if (__currentObjectUrl && __currentObjectUrl.startsWith('blob:')){
      URL.revokeObjectURL(__currentObjectUrl);
    }
  }catch{}
  __currentObjectUrl = null;

  ssLayerA.innerHTML = '';
  ssLayerB.innerHTML = '';
  ssLayerA.classList.remove('show');
  ssLayerB.classList.remove('show');

  // 再生順をランダムに作成（confirmedMedia があればそれを対象）
  const len = mediaCount();
  ssOrder = buildRandomOrder(len);

  ssRunning    = true;
  ssIndex      = 0;
  ssShowingA   = true;
  ssFirstFrame = true;

  // BGM（複数曲：ランダム連続再生）は既存のまま
  if (ssBgmList && ssBgmList.length > 0) {
    if (!ssAudio){
      ssAudio = new Audio();
      ssAudio.crossOrigin = 'anonymous';
      ssAudio.loop = false; // 曲ごとに切替
      ssAudio.addEventListener('ended', ()=>{ playRandomBgm(); });
    }
    try{ ssAudio.pause(); }catch{}
    ssAudio.muted = false;
    ssAudio.volume = 1;
    playRandomBgm();
  }

  // 初回はロード完了後にオーバーレイ表示＆フェード
  showNext(true);
}
function playRandomBgm(){
  if (!ssBgmList || ssBgmList.length===0 || !ssAudio) return;
  // 直前と同じ曲にならないようにする（1曲しかない場合はそのまま）
  let idx;
  if (ssBgmList.length === 1) {
    idx = 0;
  } else {
    do {
      idx = Math.floor(Math.random() * ssBgmList.length);
    } while (idx === __bgmIndex);
  }
  __bgmIndex = idx;
  const sel = ssBgmList[idx];
  if (!sel || !sel.url) return;
  try{ ssAudio.pause(); }catch{}
  ssAudio.src = sel.url;
  ssAudio.currentTime = 0;
  ssAudio.play().catch(()=>{ /* iOS挙動差で失敗しても次に再試行 */ });
}
function stopSlideShow(){
  if (ssNextTid){ clearTimeout(ssNextTid); ssNextTid = null; }
  if (!ssRunning) return;
  ssRunning = false;
  ssOverlay.style.display = 'none';
  ssLayerA.innerHTML = '';
  ssLayerB.innerHTML = '';

  // ★ メディアURLは解放しない（再テストで再利用するため）
  __currentObjectUrl = null;

  if (ssAudio){ try{ ssAudio.pause(); }catch{} }
}
ssOverlay.addEventListener('click', ()=>{ stopSlideShow(); resetIdleTimer(); });
function showNext(first=false){
  if (!ssRunning) return;

  const len = mediaCount();
  if (len===0){ stopSlideShow(); return; }

  // 1周ごとにランダム順を作り直す
  if (ssIndex > 0 && ssIndex % len === 0){
    ssOrder = buildRandomOrder(len);
  }

  const logical = ssOrder[ssIndex % len];
  const sourceArr = (confirmedMedia && confirmedMedia.length>0) ? confirmedMedia : ssFilesArr;

  const item = sourceArr[logical];
  const isImage = !!(item && item.type && String(item.type).startsWith('image'));
  const dur = Math.max(3, window.__ssDurationSec||10);
  const layer = ssShowingA ? ssLayerB : ssLayerA;
  layer.innerHTML='';

  const url = item && item.url ? item.url : null;
  if (!url){ ssIndex++; return showNext(first); }

  const prevUrl = __currentObjectUrl;
  __currentObjectUrl = url;

  if (isImage){
  const img = document.createElement('img');
  img.className = 'ssImg';

  const advance = ()=>{
    if (ssNextTid){ clearTimeout(ssNextTid); ssNextTid = null; }
    if (!ssRunning) return;
    ssIndex++;
    showNext(false);
  };

  img.addEventListener('load', ()=>{
  if (!ssRunning) return;
  if (first) ssOverlay.style.display='flex';

  layer.appendChild(img);
  placeAndKenBurns(img);
  crossfade();

  // ★ prevUrl は解放しない（選択メディアの blob:URL を保持）
  if (ssNextTid){ clearTimeout(ssNextTid); }
  ssNextTid = setTimeout(()=>{
    ssNextTid = null;
    if (!ssRunning) return;
    ssIndex++;
    showNext(false);
  }, dur*1000);
}, { once:true });

// ★ 追加：読み込み失敗時は次へ進む保険
img.addEventListener('error', ()=>{
  if (!ssRunning) return;
  ssIndex++;
  showNext(false);
}, { once:true });

// ★ 追加：極端に遅い場合の保険（画像が来なければ次へ）
setTimeout(()=>{
  if (!ssRunning) return;
  // まだ layer に画像が入っていなければ次へ
  if (!layer.querySelector('img')) {
    ssIndex++;
    showNext(false);
  }
}, Math.max(3000, dur*1000 + 1500));

  // 読み込み失敗でも止まらず次へ
  img.addEventListener('error', advance, { once:true });

  img.src = url;

} else {
    const vd = document.createElement('video');
    vd.src = url;
    vd.className = 'ssVid';
    vd.autoplay = true;
    vd.loop = false;
    vd.muted = true;
    vd.playsInline = true;

    const advance = ()=>{
      if (ssNextTid){ clearTimeout(ssNextTid); ssNextTid = null; }
      if (!ssRunning) return;
      ssIndex++;
      showNext(false);
    };

    vd.addEventListener('loadeddata', ()=>{
      if (!ssRunning) return;
      if (first) ssOverlay.style.display='flex';

      layer.appendChild(vd);
      crossfade();
      vd.play().catch(()=>{});

    

      // ここから保険いろいろ
      vd.addEventListener('ended',   advance, { once:true });
      vd.addEventListener('error',   advance, { once:true });
      vd.addEventListener('stalled', advance, { once:true });

      vd.addEventListener('timeupdate', ()=>{
        if (!isFinite(vd.duration) || vd.duration <= 0) return;
        if (vd.currentTime >= vd.duration - 0.2) advance();
      });

      const hardCapMs = Math.max(dur*1000, (isFinite(vd.duration)? vd.duration*1000 : 0)) + 1500;
      if (ssNextTid){ clearTimeout(ssNextTid); }
      ssNextTid = setTimeout(()=>{ ssNextTid = null; advance(); }, hardCapMs);
    }, { once:true });
  }
}

/* removed: stray video event block */
function crossfade(){
  const show = ssShowingA ? ssLayerB : ssLayerA;
  const hide = ssShowingA ? ssLayerA : ssLayerB;
  show.classList.add('show');
  hide.classList.remove('show');
  ssShowingA = !ssShowingA;
}
function placeAndKenBurns(img){
  const startScale = 1.00, endScale = 1.08;
  const dx = (Math.random()<0.5? -1:1) * 20;
  const dy = (Math.random()<0.5? -1:1) * 12;
  img.style.transformOrigin='center center';
  img.style.transform='translate(-50%,-50%) scale(1)';
  img.animate([
    { transform: `translate(-50%,-50%) scale(${startScale}) translate(0px,0px)` },
    { transform: `translate(-50%,-50%) scale(${endScale}) translate(${dx}px,${dy}px)` }
  ], { duration: Math.max(3000, (window.__ssDurationSec||10)*1000), easing:'ease-in-out', fill:'forwards' });
}

/* ========= BGMピッカー ========= */
function fmtSize(n){
  const v=Number(n); if(!isFinite(v)||v<=0) return '—';
  if(v>=1024*1024*1024) return (v/1024/1024/1024).toFixed(2)+' GB';
  if(v>=1024*1024) return (v/1024/1024).toFixed(1)+' MB';
  if(v>=1024) return Math.round(v/1024)+' KB';
  return v+' B';
}
function fmtDate(any){
  try{
    if(any==null || any==='') return '—';
    // 数値: 秒/ミリ秒両対応
    if(typeof any === 'number'){
      const ms = any < 1e12 ? any * 1000 : any;
      const d = new Date(ms);
      if(isNaN(d)) return '—';
      const p=n=>String(n).padStart(2,'0');
      return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`;
    }
    // 文字列: 数字のみなら parseInt、その他は Date に委譲
    const s = String(any).trim();
    if(/^\d+$/.test(s)){
      const num = parseInt(s,10);
      const ms = num < 1e12 ? num * 1000 : num;
      const d = new Date(ms);
      if(isNaN(d)) return '—';
      const p=n=>String(n).padStart(2,'0');
      return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`;
    }
    const d = new Date(s);
    if(isNaN(d)) return '—';
    const p=n=>String(n).padStart(2,'0');
    return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`;
  }catch{ return '—'; }
}

function fmtDuration(v){
  if(v==null || v==='') return '—';
  if(typeof v === 'number'){
    const s = v;
    if(!isFinite(s) || s<=0) return '—';
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const ss = Math.floor(s%60);
    const z = n => String(n).padStart(2,'0');
    return h>0 ? `${h}:${z(m)}:${z(ss)}` : `${m}:${z(ss)}`;
  }else{
    const s = String(v).trim();
    if(/^\d+$/.test(s)){
      return fmtDuration(parseInt(s,10));
    }
    if(/^\d{1,2}:\d{2}(:\d{2})?$/.test(s)){
      return s.length===4 ? `0:${s}` : s;
    }
    return '—';
  }
}

async function getPlayableUrlFromBgmApp(id){
  const ensureAbs = (u)=>{
    if(!u) return '';
    if(/^https?:\/\//i.test(u)) return u;           // 既に絶対URL
    if(u.startsWith('/')) return `${BGM_SITE}${u}`; // /audio/... はサイト直下を指す
    return `${BGM_SITE}/${u}`;
  };
  try{
    const r = await fetch(`${BGM_FN_BASE}/geturl?id=${encodeURIComponent(id)}`, { mode:'cors', credentials:'omit' });
    if(r.ok){
      const js = await r.json().catch(()=>null);
      const u = (js && (js.url || js.path)) ? (js.url || js.path) : '';
      if(u) return ensureAbs(u);
    }
  }catch{}
  // フォールバックは Functions の download → そこから最終URLへリダイレクトされる想定
  return `${BGM_FN_BASE}/download?id=${encodeURIComponent(id)}`;
}
let __bgmPicked = null; // {id,title,url}

function openBgmPicker(){
  __bgmPicked = null;
  $('bgmPickMsg').textContent = '';
  $('bgmPreview').src='';
  $('bgmPicker').style.display='flex';
  loadBgmList();
}
function closeBgmPicker(){
  const a = $('bgmPreview');
  try{ a.pause(); }catch{}
  a.removeAttribute('src'); // バッファも消す
  a.load();
  $('bgmPicker').style.display='none';
}

$('bgmCancel').addEventListener('click', closeBgmPicker);
$('bgmOk').addEventListener('click', async ()=>{
  const tbody = $('bgmTbody');
  const picks = Array.from(tbody.querySelectorAll('input.pick:checked'));
  if (picks.length === 0) {
    ssBgmList = [];
    saveSsSettingsUI();
    closeBgmPicker();
    updateBgmNow();
    alert('BGMの選択を解除しました');
    return;
  }

  // id → url を解決して配列化
  const list = [];
  for (const cb of picks) {
    const id = cb.dataset.id;
    const title = cb.dataset.title || '';
    try{
      const url = await getPlayableUrlFromBgmApp(id);
      if (url) list.push({ id, title, url });
    }catch{}
  }
  ssBgmList = list;
  saveSsSettingsUI();
  closeBgmPicker();
  updateBgmNow();
  alert(`${ssBgmList.length}曲を設定しました`);
});

$('bgmReload').addEventListener('click', loadBgmList);

async function loadBgmList(){
  const tbody = $('bgmTbody');
  tbody.innerHTML = `
  <tr><td colspan="4" class="center muted">読み込み中…</td></tr>
`;
  try{
    const r = await fetch(`${BGM_FN_BASE}/list`, { mode:'cors', credentials:'omit' });
    const js = await r.json();

    if(!(js && (Array.isArray(js.items) || Array.isArray(js.data)))) {
      throw new Error('一覧が取得できません');
    }
    const raw = js.items || js.data || [];

    // ゆらぎ吸収：最低限 id と title があればOK
    const items = raw.map(it => ({
  id: it.id || it.key || it.uuid || it.name || it.title || it.filename,
  title: it.title || it.name || it.filename || it.key || '(untitled)',
  durationSec: it.durationSec || it.duration || (it.meta && (it.meta.durationSec || it.meta.duration)) || null
})).filter(it => !!it.id);

    if(items.length===0){
      tbody.innerHTML = `<tr><td colspan="5" class="center muted">ファイルはありません（BGM管理アプリでアップロードしてください）</td></tr>`;
      return;
    }

    // 表描画（まずは「—」でプレースホルダ表示）
    const frag = document.createDocumentFragment();
    items.forEach(it=>{
      const tr = document.createElement('tr');
      tr.className = 'pick-row';
      tr.innerHTML = `
  <td class="center">
    <input type="checkbox" class="pick" data-id="${escapeHtml(it.id)}" data-title="${escapeHtml(it.title)}" />
  </td>
  <td class="title">${escapeHtml(it.title)}</td>
  <td class="right cell-dur">—</td>
  <td class="center">
    <button class="btn btn-preview" data-id="${escapeHtml(it.id)}" data-title="${escapeHtml(it.title)}">試聴</button>
  </td>
`;
;
      // 先にサーバが出しているフィールドがあれば反映
      if (it.durationSec) tr.querySelector('.cell-dur').textContent = fmtDuration(it.durationSec);

      tr.addEventListener('dblclick', async ()=>{
        await previewAndPick({ id: it.id, title: it.title });
      });

      // 後でHEAD＋metadataで補完
      tr.dataset.id = it.id;
      tr.dataset.title = it.title;
      frag.appendChild(tr);
    });

    tbody.innerHTML='';
    tbody.appendChild(frag);

    // ---- ここで各行のメタ情報を補完する（HEADと<audio>で） ----
    const rows = Array.from(tbody.querySelectorAll('tr'));
    for (const row of rows){
      const id = row.dataset.id;
      try{
        const url = await getPlayableUrlFromBgmApp(id);
        await fillBgmMeta(row, url);  // 日付・サイズ・duration を埋める
      }catch(e){
        // 失敗しても UI はそのまま（"—"表示）
      }
    }

  }catch(err){
    tbody.innerHTML = `<tr><td colspan="5" class="center" style="color:#ff6b6b">取得失敗：${escapeHtml(err?.message||String(err))}</td></tr>`;
  }
}
document.addEventListener('click', async (ev)=>{
  const btn = ev.target.closest('#bgmPicker .btn-preview');
  if(!btn) return;
  const row = btn.closest('tr');
  const title = btn.dataset.title || row?.querySelector('.title')?.textContent || '';
  const id = btn.dataset.id || title;
  if(!id) return;
  await previewAndPick({ id: id, title });
});

// 追加: HEAD と <audio> metadata で DATE / SIZE / DURATION を補完
async function fillBgmMeta(row, baseUrl){
  const withBust = baseUrl + ((baseUrl.includes('?')?'&':'?')+'v='+Date.now());
  try{
    const a = new Audio();
    a.crossOrigin = 'anonymous';
    a.preload = 'metadata';
    a.src = withBust;
    await new Promise((res, rej)=>{
      const tid = setTimeout(()=>rej(new Error('metadata timeout')), 6000);
      a.addEventListener('loadedmetadata', ()=>{ clearTimeout(tid); res(); }, { once:true });
      a.addEventListener('error', ()=>{ clearTimeout(tid); rej(new Error('metadata error')); }, { once:true });
    });
    if (isFinite(a.duration) && a.duration > 0){
      row.querySelector('.cell-dur').textContent = fmtDuration(Math.round(a.duration));
    }
    try{ a.pause(); }catch{}
    a.removeAttribute('src');
    a.load();
  }catch{}
}

async function previewAndPick(it){
  const msg = $('bgmPickMsg');
  const a = $('bgmPreview');
  try{
    msg.textContent = 'URL 取得中…';
    const url = await getPlayableUrlFromBgmApp(it.id);
    const withBust = url + ((url.includes('?')?'&':'?')+'v='+Date.now());

    // CORS / 再生安定化
    try{ a.pause(); }catch{}
    a.removeAttribute('src'); // 古いソースをクリア
    a.load();
    a.crossOrigin = 'anonymous';
    a.src = withBust;

    // エラー監視
    let errorOnce = false;
    a.onerror = ()=>{
      if(errorOnce) return;
      errorOnce = true;
      msg.textContent = '試聴エラー：音源にアクセスできません';
    };

    // ユーザー操作起因なので play は許可されるはず
    await a.play();
    __bgmPicked = { id: it.id, title: it.title || '', url };
    msg.textContent = `選択中：${it.title || '(タイトルなし)'}`;
  }catch(e){
    msg.textContent = '再生に失敗しました';
  }
}

/* 初期表示：①タイトル */
gotoTitle();
</script>
</body>
</html>